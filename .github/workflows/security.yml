# K-ERP Security Scanning Pipeline
# Runs security checks on schedule and PRs

name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 2 AM KST (17:00 UTC previous day)
    - cron: '0 17 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ============================================
  # Go Security Scanning
  # ============================================
  go-security:
    name: Go Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: go.sum

      # Vulnerability scanning with govulncheck
      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...
        continue-on-error: true

      # Static analysis with gosec
      - name: Run gosec
        uses: securego/gosec@master
        with:
          args: -fmt=sarif -out=gosec-results.sarif ./...

      - name: Upload gosec results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: gosec-results.sarif
          category: gosec

      # Dependency check
      - name: Check for outdated dependencies
        run: |
          go list -u -m all 2>/dev/null | grep '\[' || echo "All dependencies up to date"

  # ============================================
  # Frontend Security Scanning
  # ============================================
  npm-security:
    name: NPM Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      # NPM Audit
      - name: Run npm audit
        working-directory: web
        run: |
          npm audit --audit-level=high || true
        continue-on-error: true

      # Dependency vulnerability check
      - name: Check vulnerabilities with better-npm-audit
        working-directory: web
        run: |
          npx better-npm-audit audit --level high || true

  # ============================================
  # Container Image Scanning
  # ============================================
  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build API image for scanning
        run: |
          docker build -t kerp-api:scan . -f ./deployments/docker/Dockerfile.api
        continue-on-error: true

      # Trivy vulnerability scanner
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'kerp-api:scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: trivy

      # Dockle for Dockerfile best practices
      - name: Run Dockle
        uses: goodwithtech/dockle-action@v0.1.2
        with:
          image: kerp-api:scan
          format: 'sarif'
          output: 'dockle-results.sarif'
          exit-code: '0'

  # ============================================
  # Secret Scanning
  # ============================================
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Gitleaks for secret detection
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      # TruffleHog for additional secret scanning
      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified

  # ============================================
  # SAST with CodeQL
  # ============================================
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        language: ['go', 'javascript']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: +security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"

  # ============================================
  # License Compliance
  # ============================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # Go license check
      - name: Check Go licenses
        run: |
          go install github.com/google/go-licenses@latest
          go-licenses check ./... --disallowed_types=restricted,reciprocal || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # NPM license check
      - name: Check NPM licenses
        working-directory: web
        run: |
          npx license-checker --production --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;CC0-1.0;Unlicense' || true

  # ============================================
  # Security Report Summary
  # ============================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [go-security, npm-security, secret-scan, codeql, license-check]
    if: always()

    steps:
      - name: Check security results
        env:
          GO_RESULT: ${{ needs.go-security.result }}
          NPM_RESULT: ${{ needs.npm-security.result }}
          SECRET_RESULT: ${{ needs.secret-scan.result }}
          CODEQL_RESULT: ${{ needs.codeql.result }}
          LICENSE_RESULT: ${{ needs.license-check.result }}
        run: |
          echo "=== Security Scan Summary ==="
          echo "Go Security: ${GO_RESULT}"
          echo "NPM Security: ${NPM_RESULT}"
          echo "Secret Scan: ${SECRET_RESULT}"
          echo "CodeQL: ${CODEQL_RESULT}"
          echo "License Check: ${LICENSE_RESULT}"

          if [ "${SECRET_RESULT}" == "failure" ]; then
            echo "CRITICAL: Secrets detected in repository!"
            exit 1
          fi

          echo "Security scan completed"
