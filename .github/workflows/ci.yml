# K-ERP CI Pipeline
# Go Backend + React Frontend Build & Test

name: CI Pipeline

on:
  push:
    branches: [main, develop, 'feature/**', 'release/**']
  pull_request:
    branches: [main, develop]

env:
  GO_VERSION: '1.22'
  NODE_VERSION: '20'
  POSTGRES_VERSION: '16'

jobs:
  # ============================================
  # Backend (Go) Build & Test
  # ============================================
  backend:
    name: Backend CI
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: kerp_test
          POSTGRES_PASSWORD: kerp_test_password
          POSTGRES_DB: kerp_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: backend/go.sum

      - name: Install dependencies
        working-directory: backend
        run: go mod download

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: backend
          args: --timeout=5m

      - name: Run unit tests
        working-directory: backend
        env:
          DATABASE_URL: postgres://kerp_test:kerp_test_password@localhost:5432/kerp_test?sslmode=disable
          REDIS_URL: redis://localhost:6379
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.out
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: Build binary
        working-directory: backend
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o bin/api ./cmd/api
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o bin/worker ./cmd/worker

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-binaries
          path: backend/bin/
          retention-days: 7

  # ============================================
  # Frontend (React) Build & Test
  # ============================================
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Run ESLint
        working-directory: web
        run: npm run lint

      - name: Run type check
        working-directory: web
        run: npm run typecheck

      - name: Run unit tests
        working-directory: web
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./web/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

      - name: Build production bundle
        working-directory: web
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web/dist/
          retention-days: 7

  # ============================================
  # Integration Tests
  # ============================================
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend, frontend]

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: kerp_test
          POSTGRES_PASSWORD: kerp_test_password
          POSTGRES_DB: kerp_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

      nats:
        image: nats:2.10-alpine
        ports:
          - 4222:4222

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run database migrations
        working-directory: backend
        env:
          DATABASE_URL: postgres://kerp_test:kerp_test_password@localhost:5432/kerp_test?sslmode=disable
        run: |
          go run ./cmd/migrate up

      - name: Run integration tests
        working-directory: backend
        env:
          DATABASE_URL: postgres://kerp_test:kerp_test_password@localhost:5432/kerp_test?sslmode=disable
          REDIS_URL: redis://localhost:6379
          NATS_URL: nats://localhost:4222
          TEST_MODE: integration
        run: |
          go test -v -tags=integration ./internal/...

  # ============================================
  # Build Status Summary
  # ============================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [backend, frontend, integration]
    if: always()

    steps:
      - name: Check CI results
        env:
          BACKEND_RESULT: ${{ needs.backend.result }}
          FRONTEND_RESULT: ${{ needs.frontend.result }}
          INTEGRATION_RESULT: ${{ needs.integration.result }}
        run: |
          if [ "$BACKEND_RESULT" != "success" ] || \
             [ "$FRONTEND_RESULT" != "success" ] || \
             [ "$INTEGRATION_RESULT" != "success" ]; then
            echo "CI failed!"
            exit 1
          fi
          echo "All CI checks passed!"
