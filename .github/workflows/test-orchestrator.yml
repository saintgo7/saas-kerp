# Test Automation Orchestrator - GitHub Actions Workflow
# K-ERP SaaS Platform CI/CD Pipeline

name: Test Orchestrator

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'phase/**'
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Nightly comprehensive tests at 2 AM KST (5 PM UTC)
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test execution mode'
        required: false
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - full
          - nightly
      test_types:
        description: 'Test types to run (comma-separated)'
        required: false
        default: 'unit,integration'

env:
  GO_VERSION: '1.22'
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # Job: Change Detection
  # ============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      go_changed: ${{ steps.changes.outputs.go }}
      python_changed: ${{ steps.changes.outputs.python }}
      frontend_changed: ${{ steps.changes.outputs.frontend }}
      db_changed: ${{ steps.changes.outputs.db }}
      docs_only: ${{ steps.changes.outputs.docs_only }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            go:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
            python:
              - 'python-services/**/*.py'
              - 'python-services/**/requirements*.txt'
            frontend:
              - 'web/**/*.ts'
              - 'web/**/*.tsx'
              - 'web/**/package*.json'
            db:
              - 'db/migrations/**'
              - 'db/queries/**'
            docs_only:
              - '**/*.md'
              - 'docs/**'

  # ============================================================================
  # Job: Lint
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.docs_only != 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: golangci-lint
        if: needs.detect-changes.outputs.go_changed == 'true'
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

      - name: Set up Python
        if: needs.detect-changes.outputs.python_changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Python lint
        if: needs.detect-changes.outputs.python_changed == 'true'
        run: |
          pip install ruff black mypy
          ruff check python-services/
          black --check python-services/

      - name: Set up Node
        if: needs.detect-changes.outputs.frontend_changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Frontend lint
        if: needs.detect-changes.outputs.frontend_changed == 'true'
        working-directory: web
        run: |
          npm ci
          npm run lint

  # ============================================================================
  # Job: Unit Tests
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, lint]
    if: needs.detect-changes.outputs.docs_only != 'true'
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run Go unit tests (shard ${{ matrix.shard }})
        if: needs.detect-changes.outputs.go_changed == 'true'
        run: |
          # Get all packages
          packages=$(go list ./... | grep -v vendor)
          total=$(echo "$packages" | wc -l)
          per_shard=$(( (total + 3) / 4 ))
          start=$(( (${{ matrix.shard }} - 1) * per_shard + 1 ))
          end=$(( ${{ matrix.shard }} * per_shard ))

          # Run tests for this shard
          shard_packages=$(echo "$packages" | sed -n "${start},${end}p")
          if [ -n "$shard_packages" ]; then
            echo "$shard_packages" | xargs go test -v -race -short \
              -coverprofile=coverage-${{ matrix.shard }}.out \
              -covermode=atomic
          fi

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit-${{ matrix.shard }}
          path: coverage-*.out
          retention-days: 1

  # ============================================================================
  # Job: Integration Tests
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, unit-tests]
    if: |
      needs.detect-changes.outputs.docs_only != 'true' &&
      (needs.detect-changes.outputs.go_changed == 'true' || needs.detect-changes.outputs.db_changed == 'true')
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: kerp_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      nats:
        image: nats:2.10-alpine
        ports:
          - 4222:4222
        options: >-
          --health-cmd "wget -q --spider http://localhost:8222/healthz"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run migrations
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/kerp_test?sslmode=disable
        run: |
          go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
          migrate -path db/migrations -database "$DATABASE_URL" up

      - name: Run integration tests
        env:
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 5432
          TEST_DB_NAME: kerp_test
          TEST_DB_USER: test
          TEST_DB_PASSWORD: test
          TEST_REDIS_HOST: localhost
          TEST_REDIS_PORT: 6379
          TEST_NATS_URL: nats://localhost:4222
        run: |
          go test -v -race -tags=integration \
            -coverprofile=coverage-integration.out \
            -covermode=atomic \
            ./...

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-integration
          path: coverage-integration.out
          retention-days: 1

  # ============================================================================
  # Job: Python Tests
  # ============================================================================
  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, lint]
    if: |
      needs.detect-changes.outputs.docs_only != 'true' &&
      needs.detect-changes.outputs.python_changed == 'true'
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: kerp_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd python-services
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-xdist

      - name: Install Playwright browsers
        run: |
          pip install playwright
          playwright install chromium

      - name: Run Python tests
        env:
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 5432
          TEST_DB_NAME: kerp_test
          TEST_DB_USER: test
          TEST_DB_PASSWORD: test
        run: |
          cd python-services
          pytest -v -n auto \
            --cov=. \
            --cov-report=xml:../coverage-python.xml \
            --junitxml=../test-results-python.xml

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-python
          path: coverage-python.xml
          retention-days: 1

  # ============================================================================
  # Job: Frontend Tests
  # ============================================================================
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, lint]
    if: |
      needs.detect-changes.outputs.docs_only != 'true' &&
      needs.detect-changes.outputs.frontend_changed == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Run frontend tests
        working-directory: web
        run: |
          npm test -- --coverage --reporter=junit --outputFile=../test-results-frontend.xml

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-frontend
          path: web/coverage/
          retention-days: 1

  # ============================================================================
  # Job: E2E Tests
  # ============================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && contains(github.event.inputs.test_types, 'e2e'))
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: kerp_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Playwright
        run: |
          npm install -g playwright
          npx playwright install --with-deps chromium

      - name: Build and start application
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: kerp_test
          DB_USER: test
          DB_PASSWORD: test
          REDIS_HOST: localhost
        run: |
          go build -o bin/api ./cmd/api
          ./bin/api &
          sleep 5

      - name: Run E2E tests
        run: |
          npx playwright test tests/e2e/ \
            --reporter=junit \
            --output=test-results-e2e.xml

      - name: Upload E2E artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-screenshots
          path: tests/e2e/screenshots/
          retention-days: 7

  # ============================================================================
  # Job: Coverage Report
  # ============================================================================
  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, python-tests, frontend-tests]
    if: always() && needs.unit-tests.result != 'skipped'
    steps:
      - uses: actions/checkout@v4

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          merge-multiple: true
          path: coverage/

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Merge Go coverage
        run: |
          # Create coverage directory if it doesn't exist
          mkdir -p coverage/

          # Find all Go coverage files
          find coverage/ -name "*.out" -type f | head -20 || true

          # Merge coverage files if any exist
          if find coverage/ -name "*.out" -type f 2>/dev/null | grep -q .; then
            echo "mode: atomic" > coverage/merged.out
            find coverage/ -name "*.out" -type f -exec tail -n +2 {} \; >> coverage/merged.out 2>/dev/null || true

            # Generate report
            if [ -s coverage/merged.out ]; then
              go tool cover -func=coverage/merged.out | tail -1
            fi
          else
            echo "No coverage files found. Skipping coverage merge."
            # Create empty merged.out to prevent Codecov failure
            echo "mode: atomic" > coverage/merged.out
          fi

      - name: Prepare coverage files
        run: |
          # Ensure coverage directory exists
          mkdir -p coverage/
          touch coverage/merged.out
          ls -la coverage/ || true

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/merged.out
          flags: unittests
          fail_ci_if_error: false
          verbose: true

      - name: Coverage summary
        run: |
          echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f coverage/merged.out ] && [ -s coverage/merged.out ]; then
            coverage=$(go tool cover -func=coverage/merged.out | grep total | awk '{print $3}')
            if [ -n "$coverage" ]; then
              echo "**Go Coverage:** $coverage" >> $GITHUB_STEP_SUMMARY
            else
              echo "Go coverage data unavailable" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No coverage data collected in this run" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Job: Performance Tests (Nightly)
  # ============================================================================
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: github.event_name == 'schedule'
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: kerp_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build application
        run: go build -o bin/api ./cmd/api

      - name: Start application
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: kerp_test
          DB_USER: test
          DB_PASSWORD: test
          REDIS_HOST: localhost
        run: |
          ./bin/api &
          sleep 5

      - name: Run k6 load tests
        uses: grafana/k6-action@v0.3.1
        with:
          filename: tests/performance/load-test.js
          flags: --out json=results.json

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: results.json
          retention-days: 30

  # ============================================================================
  # Job: Notify
  # ============================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, python-tests, frontend-tests, e2e-tests]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.unit-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.integration-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.python-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.frontend-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.e2e-tests.result }}" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: steps.status.outputs.status == 'failure'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "K-ERP Test Pipeline Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":x: *Test Pipeline Failed*\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
