# K-ERP v0.2 - 아키텍처 설계

**문서 버전**: 0.2.0
**작성일**: 2026-01-16
**상태**: 검토 대기

---

## 목차

1. [설계 원칙](#1-설계-원칙)
2. [시스템 아키텍처](#2-시스템-아키텍처)
3. [Go API Server 설계](#3-go-api-server-설계)
4. [Python 서비스 설계](#4-python-서비스-설계)
5. [데이터 계층](#5-데이터-계층)
6. [보안 아키텍처](#6-보안-아키텍처)
7. [확장성 설계](#7-확장성-설계)

---

## 1. 설계 원칙

### 1.1 Clean Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Clean Architecture                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│    ┌─────────────────────────────────────────────────┐      │
│    │              Frameworks & Drivers                │      │
│    │  ┌─────────────────────────────────────────┐    │      │
│    │  │            Interface Adapters            │    │      │
│    │  │  ┌─────────────────────────────────┐    │    │      │
│    │  │  │        Application Layer        │    │    │      │
│    │  │  │  ┌─────────────────────────┐    │    │    │      │
│    │  │  │  │     Domain Layer       │    │    │    │      │
│    │  │  │  │   (Entities, Rules)    │    │    │    │      │
│    │  │  │  └─────────────────────────┘    │    │    │      │
│    │  │  │         Use Cases               │    │    │      │
│    │  │  └─────────────────────────────────┘    │    │      │
│    │  │     Controllers, Gateways, Presenters   │    │      │
│    │  └─────────────────────────────────────────┘    │      │
│    │         Web, DB, External Interfaces            │      │
│    └─────────────────────────────────────────────────┘      │
│                                                             │
│  의존성 방향: 외부 → 내부 (역방향 금지)                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 핵심 원칙

| 원칙 | 설명 | 적용 |
|------|------|------|
| 단일 책임 | 각 모듈은 하나의 책임만 | Service, Repository 분리 |
| 의존성 역전 | 고수준이 저수준에 의존하지 않음 | Interface 기반 설계 |
| 개방-폐쇄 | 확장에 열려있고 수정에 닫힘 | Provider 패턴 |
| 인터페이스 분리 | 클라이언트별 인터페이스 | gRPC/REST 분리 |

---

## 2. 시스템 아키텍처

### 2.1 전체 구성도

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        Production Environment                             │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                         Kubernetes Cluster                         │  │
│  │                                                                    │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │  │
│  │  │   Ingress    │  │   Service    │  │   Service    │             │  │
│  │  │  Controller  │  │   Mesh       │  │   Discovery  │             │  │
│  │  │   (Nginx)    │  │  (Istio)     │  │  (CoreDNS)   │             │  │
│  │  └──────┬───────┘  └──────────────┘  └──────────────┘             │  │
│  │         │                                                          │  │
│  │  ┌──────▼───────────────────────────────────────────────────────┐  │  │
│  │  │                    Application Namespace                      │  │  │
│  │  │                                                               │  │  │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │  │  │
│  │  │  │              Go API Server (Deployment)                 │  │  │  │
│  │  │  │                                                         │  │  │  │
│  │  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │  │  │  │
│  │  │  │  │ Pod 1   │ │ Pod 2   │ │ Pod 3   │ │ Pod N   │       │  │  │  │
│  │  │  │  │ :8080   │ │ :8080   │ │ :8080   │ │ :8080   │       │  │  │  │
│  │  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │  │  │  │
│  │  │  │           HPA: min=3, max=20, CPU=70%                   │  │  │  │
│  │  │  └─────────────────────────────────────────────────────────┘  │  │  │
│  │  │                          │ gRPC                               │  │  │
│  │  │           ┌──────────────┴──────────────┐                     │  │  │
│  │  │           ▼                             ▼                     │  │  │
│  │  │  ┌─────────────────────┐  ┌─────────────────────┐             │  │  │
│  │  │  │ Python Tax Scraper  │  │ Python Insurance    │             │  │  │
│  │  │  │    (Deployment)     │  │   EDI (Deployment)  │             │  │  │
│  │  │  │                     │  │                     │             │  │  │
│  │  │  │  ┌───────┐ ┌───────┐│  │  ┌───────┐ ┌───────┐│             │  │  │
│  │  │  │  │Pod 1  │ │Pod 2  ││  │  │Pod 1  │ │Pod 2  ││             │  │  │
│  │  │  │  │:50051 │ │:50051 ││  │  │:50052 │ │:50052 ││             │  │  │
│  │  │  │  └───────┘ └───────┘│  │  └───────┘ └───────┘│             │  │  │
│  │  │  │   HPA: min=2, max=5 │  │   HPA: min=2, max=5 │             │  │  │
│  │  │  └─────────────────────┘  └─────────────────────┘             │  │  │
│  │  │                                                               │  │  │
│  │  └───────────────────────────────────────────────────────────────┘  │  │
│  │                                                                    │  │
│  │  ┌──────────────────────────────────────────────────────────────┐  │  │
│  │  │                     Data Namespace                            │  │  │
│  │  │                                                               │  │  │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐          │  │  │
│  │  │  │  PostgreSQL  │ │    Redis     │ │    NATS      │          │  │  │
│  │  │  │  (StatefulSet)│ │   Cluster   │ │  JetStream   │          │  │  │
│  │  │  │  Primary +   │ │   (3 nodes) │ │   (3 nodes)  │          │  │  │
│  │  │  │  2 Replicas  │ │              │ │              │          │  │  │
│  │  │  └──────────────┘ └──────────────┘ └──────────────┘          │  │  │
│  │  │                                                               │  │  │
│  │  └──────────────────────────────────────────────────────────────┘  │  │
│  │                                                                    │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 2.2 서비스 상호작용

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Service Interaction Flow                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [Client Request: 세금계산서 발행]                                      │
│           │                                                             │
│           ▼                                                             │
│  ┌─────────────────┐                                                    │
│  │   Go API Server │                                                    │
│  │                 │                                                    │
│  │  1. 요청 검증   │                                                    │
│  │  2. 인증/인가   │                                                    │
│  │  3. Provider    │                                                    │
│  │     선택        │                                                    │
│  └────────┬────────┘                                                    │
│           │                                                             │
│     ┌─────┴─────┬──────────────┐                                        │
│     ▼           ▼              ▼                                        │
│  [Priority 1] [Priority 2] [Priority 3]                                 │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                                    │
│  │ Scraper │ │ NTS API │ │ Popbill │                                    │
│  │ (Python)│ │  (Go)   │ │  (Go)   │                                    │
│  │  무료   │ │  무료   │ │  유료   │                                    │
│  └────┬────┘ └────┬────┘ └────┬────┘                                    │
│       │           │           │                                         │
│       ▼           ▼           ▼                                         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                                    │
│  │ Hometax │ │ NTS API │ │ Popbill │                                    │
│  │  Server │ │  Server │ │  Server │                                    │
│  └─────────┘ └─────────┘ └─────────┘                                    │
│                                                                         │
│  Fallback Logic:                                                        │
│  ┌─────────────────────────────────────────────────────────────┐        │
│  │ if Scraper.Issue() fails:                                   │        │
│  │     if NTS_API.Issue() fails:                               │        │
│  │         return Popbill.Issue()  // Guaranteed                │        │
│  │     return NTS_API.Issue()                                   │        │
│  │ return Scraper.Issue()                                       │        │
│  └─────────────────────────────────────────────────────────────┘        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Go API Server 설계

### 3.1 디렉토리 구조

```
k-erp/
├── cmd/
│   ├── api/
│   │   └── main.go                 # API 서버 진입점
│   └── worker/
│       └── main.go                 # 백그라운드 워커
│
├── internal/
│   ├── domain/                     # 도메인 모델 (엔티티)
│   │   ├── account.go              # 계정과목
│   │   ├── voucher.go              # 전표
│   │   ├── invoice.go              # 세금계산서
│   │   ├── employee.go             # 사원
│   │   ├── payroll.go              # 급여
│   │   └── insurance.go            # 4대보험
│   │
│   ├── dto/                        # 데이터 전송 객체
│   │   ├── request/
│   │   │   ├── invoice_request.go
│   │   │   └── payroll_request.go
│   │   └── response/
│   │       ├── invoice_response.go
│   │       └── payroll_response.go
│   │
│   ├── repository/                 # 데이터 접근 계층
│   │   ├── interface.go            # Repository 인터페이스
│   │   ├── account_repo.go
│   │   ├── voucher_repo.go
│   │   └── invoice_repo.go
│   │
│   ├── service/                    # 비즈니스 로직
│   │   ├── account_service.go
│   │   ├── voucher_service.go
│   │   ├── invoice_service.go
│   │   └── payroll_service.go
│   │
│   ├── handler/                    # HTTP 핸들러
│   │   ├── account_handler.go
│   │   ├── voucher_handler.go
│   │   ├── invoice_handler.go
│   │   └── payroll_handler.go
│   │
│   ├── middleware/                 # 미들웨어
│   │   ├── auth.go                 # JWT 인증
│   │   ├── tenant.go               # 테넌트 주입
│   │   ├── logging.go              # 요청 로깅
│   │   └── recovery.go             # 패닉 복구
│   │
│   ├── provider/                   # 외부 서비스 Provider
│   │   ├── invoice/
│   │   │   ├── interface.go        # Provider 인터페이스
│   │   │   ├── scraper.go          # gRPC Client (Python)
│   │   │   ├── nts_api.go          # NTS API Client
│   │   │   ├── popbill.go          # Popbill Client
│   │   │   └── chain.go            # Provider Chain
│   │   └── insurance/
│   │       ├── interface.go
│   │       └── edi_client.go       # gRPC Client (Python)
│   │
│   └── grpc/                       # gRPC 클라이언트
│       ├── scraper_client.go
│       └── insurance_client.go
│
├── pkg/                            # 공개 유틸리티
│   ├── config/
│   ├── errors/
│   ├── logger/
│   ├── validator/
│   └── utils/
│
├── db/
│   ├── migrations/                 # SQL 마이그레이션
│   ├── queries/                    # sqlc 쿼리
│   └── seeds/                      # 초기 데이터
│
├── api/
│   └── proto/                      # gRPC Proto 정의
│       ├── scraper.proto
│       └── insurance.proto
│
└── deployments/
    ├── docker/
    └── k8s/
```

### 3.2 Provider 패턴 구현

```go
// internal/provider/invoice/interface.go
package invoice

import (
    "context"
    "github.com/kerp/internal/domain"
)

// Provider 인터페이스 정의
type Provider interface {
    // Name 은 Provider 이름 반환
    Name() string

    // Priority 는 우선순위 반환 (낮을수록 우선)
    Priority() int

    // IsAvailable 은 Provider 사용 가능 여부 확인
    IsAvailable(ctx context.Context) bool

    // Issue 는 세금계산서 발행
    Issue(ctx context.Context, req *IssueRequest) (*IssueResponse, error)

    // Search 는 세금계산서 조회
    Search(ctx context.Context, req *SearchRequest) ([]*domain.Invoice, error)

    // GetDetail 은 세금계산서 상세 조회
    GetDetail(ctx context.Context, ntsConfirmNum string) (*domain.Invoice, error)
}

// IssueRequest 발행 요청
type IssueRequest struct {
    CompanyID      string
    SupplierBRN    string    // 공급자 사업자번호
    BuyerBRN       string    // 공급받는자 사업자번호
    IssueDate      time.Time
    SupplyAmount   int64     // 공급가액
    TaxAmount      int64     // 세액
    TotalAmount    int64     // 합계
    Items          []InvoiceItem
}

// IssueResponse 발행 응답
type IssueResponse struct {
    NTSConfirmNum  string    // 국세청 승인번호
    IssueID        string    // 발행 ID
    IssuedAt       time.Time
    Provider       string    // 사용된 Provider
}
```

```go
// internal/provider/invoice/chain.go
package invoice

import (
    "context"
    "sort"
    "github.com/kerp/pkg/errors"
)

// ProviderChain 은 Provider들을 우선순위대로 실행
type ProviderChain struct {
    providers []Provider
    logger    *zap.Logger
}

// NewProviderChain 생성
func NewProviderChain(providers []Provider, logger *zap.Logger) *ProviderChain {
    // 우선순위 정렬
    sort.Slice(providers, func(i, j int) bool {
        return providers[i].Priority() < providers[j].Priority()
    })

    return &ProviderChain{
        providers: providers,
        logger:    logger,
    }
}

// Issue 는 우선순위대로 Provider 시도
func (c *ProviderChain) Issue(ctx context.Context, req *IssueRequest) (*IssueResponse, error) {
    var lastErr error

    for _, provider := range c.providers {
        // 사용 가능 여부 확인
        if !provider.IsAvailable(ctx) {
            c.logger.Info("provider not available",
                zap.String("provider", provider.Name()))
            continue
        }

        c.logger.Info("trying provider",
            zap.String("provider", provider.Name()),
            zap.Int("priority", provider.Priority()))

        // 발행 시도
        resp, err := provider.Issue(ctx, req)
        if err != nil {
            c.logger.Warn("provider failed",
                zap.String("provider", provider.Name()),
                zap.Error(err))
            lastErr = err
            continue
        }

        c.logger.Info("invoice issued successfully",
            zap.String("provider", provider.Name()),
            zap.String("nts_confirm_num", resp.NTSConfirmNum))

        return resp, nil
    }

    return nil, errors.Wrap(lastErr, "all providers failed")
}
```

### 3.3 gRPC 클라이언트 구현

```go
// internal/grpc/scraper_client.go
package grpc

import (
    "context"
    "time"

    "google.golang.org/grpc"
    "google.golang.org/grpc/credentials/insecure"
    "google.golang.org/grpc/keepalive"

    pb "github.com/kerp/api/proto/scraper"
)

// ScraperClient gRPC 클라이언트
type ScraperClient struct {
    conn   *grpc.ClientConn
    client pb.ScraperServiceClient
    config *Config
}

// Config 설정
type Config struct {
    Address         string        // "python-scraper:50051"
    Timeout         time.Duration // 30s
    MaxRetries      int           // 3
    KeepAliveTime   time.Duration // 10s
}

// NewScraperClient 생성
func NewScraperClient(cfg *Config) (*ScraperClient, error) {
    opts := []grpc.DialOption{
        grpc.WithTransportCredentials(insecure.NewCredentials()),
        grpc.WithKeepaliveParams(keepalive.ClientParameters{
            Time:                cfg.KeepAliveTime,
            Timeout:             cfg.Timeout,
            PermitWithoutStream: true,
        }),
        grpc.WithDefaultCallOptions(
            grpc.MaxCallRecvMsgSize(10 * 1024 * 1024), // 10MB
        ),
    }

    conn, err := grpc.Dial(cfg.Address, opts...)
    if err != nil {
        return nil, fmt.Errorf("failed to connect to scraper: %w", err)
    }

    return &ScraperClient{
        conn:   conn,
        client: pb.NewScraperServiceClient(conn),
        config: cfg,
    }, nil
}

// IssueInvoice 세금계산서 발행
func (c *ScraperClient) IssueInvoice(ctx context.Context, req *pb.IssueRequest) (*pb.IssueResponse, error) {
    ctx, cancel := context.WithTimeout(ctx, c.config.Timeout)
    defer cancel()

    return c.client.IssueInvoice(ctx, req)
}

// SearchInvoices 세금계산서 조회
func (c *ScraperClient) SearchInvoices(ctx context.Context, req *pb.SearchRequest) (*pb.SearchResponse, error) {
    ctx, cancel := context.WithTimeout(ctx, c.config.Timeout)
    defer cancel()

    return c.client.SearchInvoices(ctx, req)
}

// HealthCheck 헬스 체크
func (c *ScraperClient) HealthCheck(ctx context.Context) error {
    ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
    defer cancel()

    resp, err := c.client.HealthCheck(ctx, &pb.HealthRequest{})
    if err != nil {
        return err
    }

    if resp.Status != pb.HealthStatus_SERVING {
        return fmt.Errorf("scraper not serving: %s", resp.Status)
    }

    return nil
}

// Close 연결 종료
func (c *ScraperClient) Close() error {
    return c.conn.Close()
}
```

---

## 4. Python 서비스 설계

### 4.1 디렉토리 구조

```
python-services/
├── tax-scraper/                    # 세금계산서 스크래핑 서비스
│   ├── src/
│   │   ├── __init__.py
│   │   ├── main.py                 # gRPC 서버 진입점
│   │   ├── server.py               # gRPC 서버 구현
│   │   ├── crypto/
│   │   │   ├── __init__.py
│   │   │   └── seed.py             # SEED-CBC 암호화
│   │   ├── scraper/
│   │   │   ├── __init__.py
│   │   │   ├── hometax.py          # 홈택스 스크래퍼
│   │   │   ├── auth.py             # 인증 처리
│   │   │   └── invoice.py          # 세금계산서 처리
│   │   └── proto/
│   │       ├── __init__.py
│   │       ├── scraper_pb2.py      # 생성된 코드
│   │       └── scraper_pb2_grpc.py
│   ├── tests/
│   │   ├── test_seed.py
│   │   └── test_scraper.py
│   ├── Dockerfile
│   ├── requirements.txt
│   └── pyproject.toml
│
└── insurance-edi/                  # 4대보험 EDI 서비스
    ├── src/
    │   ├── __init__.py
    │   ├── main.py
    │   ├── server.py
    │   ├── crypto/
    │   │   ├── __init__.py
    │   │   ├── seed.py             # SEED-CBC
    │   │   └── aria.py             # ARIA-CBC
    │   ├── edi/
    │   │   ├── __init__.py
    │   │   ├── generator.py        # EDI 메시지 생성
    │   │   ├── parser.py           # EDI 응답 파싱
    │   │   └── signature.py        # PKCS#7 서명
    │   ├── agency/
    │   │   ├── __init__.py
    │   │   ├── nps.py              # 국민연금
    │   │   ├── nhis.py             # 건강보험
    │   │   ├── ei.py               # 고용보험
    │   │   └── wci.py              # 산재보험
    │   └── proto/
    │       ├── insurance_pb2.py
    │       └── insurance_pb2_grpc.py
    ├── tests/
    ├── Dockerfile
    └── requirements.txt
```

### 4.2 Python 서비스 핵심 구현

```python
# tax-scraper/src/crypto/seed.py
"""SEED-CBC 암호화 모듈"""

from Crypto.Cipher import AES
from typing import Optional
import struct


class SEEDCipher:
    """
    SEED-CBC 암호화/복호화

    SEED는 한국 표준 블록 암호화 알고리즘 (TTAS.KO-12.0004/R1)
    홈택스, 국민연금, 고용보험, 산재보험에서 사용
    """

    BLOCK_SIZE = 16  # 128 bits

    def __init__(self, key: bytes, iv: bytes):
        """
        Args:
            key: 16바이트 (128비트) 암호화 키
            iv: 16바이트 초기화 벡터
        """
        if len(key) != 16:
            raise ValueError(f"Key must be 16 bytes, got {len(key)}")
        if len(iv) != 16:
            raise ValueError(f"IV must be 16 bytes, got {len(iv)}")

        self.key = key
        self.iv = iv
        self._round_keys = self._generate_round_keys()

    def _generate_round_keys(self) -> list[bytes]:
        """라운드 키 생성 (16라운드)"""
        # SEED 라운드 키 생성 로직
        # 실제 구현은 KISA 표준 문서 참조
        round_keys = []
        # ... 생략
        return round_keys

    def encrypt(self, plaintext: bytes) -> bytes:
        """
        PKCS7 패딩 후 CBC 모드 암호화

        Args:
            plaintext: 평문 데이터

        Returns:
            암호문
        """
        # PKCS7 패딩
        padding_len = self.BLOCK_SIZE - (len(plaintext) % self.BLOCK_SIZE)
        padded = plaintext + bytes([padding_len] * padding_len)

        # CBC 암호화
        ciphertext = b''
        prev_block = self.iv

        for i in range(0, len(padded), self.BLOCK_SIZE):
            block = padded[i:i + self.BLOCK_SIZE]
            xored = bytes(a ^ b for a, b in zip(block, prev_block))
            encrypted = self._encrypt_block(xored)
            ciphertext += encrypted
            prev_block = encrypted

        return ciphertext

    def decrypt(self, ciphertext: bytes) -> bytes:
        """
        CBC 모드 복호화 후 PKCS7 패딩 제거

        Args:
            ciphertext: 암호문

        Returns:
            평문 데이터
        """
        if len(ciphertext) % self.BLOCK_SIZE != 0:
            raise ValueError("Invalid ciphertext length")

        # CBC 복호화
        plaintext = b''
        prev_block = self.iv

        for i in range(0, len(ciphertext), self.BLOCK_SIZE):
            block = ciphertext[i:i + self.BLOCK_SIZE]
            decrypted = self._decrypt_block(block)
            plaintext += bytes(a ^ b for a, b in zip(decrypted, prev_block))
            prev_block = block

        # PKCS7 패딩 제거
        padding_len = plaintext[-1]
        return plaintext[:-padding_len]

    def _encrypt_block(self, block: bytes) -> bytes:
        """단일 블록 암호화"""
        # SEED 암호화 알고리즘 (16라운드)
        # ... 실제 구현
        pass

    def _decrypt_block(self, block: bytes) -> bytes:
        """단일 블록 복호화"""
        # SEED 복호화 알고리즘 (16라운드, 역순)
        # ... 실제 구현
        pass
```

```python
# tax-scraper/src/scraper/hometax.py
"""홈택스 세금계산서 스크래퍼"""

import asyncio
from dataclasses import dataclass
from datetime import date
from typing import Optional
from playwright.async_api import async_playwright, Browser, Page

from ..crypto.seed import SEEDCipher


@dataclass
class HometaxCredential:
    """홈택스 인증 정보"""
    cert_path: str          # 공인인증서 경로
    cert_password: str      # 인증서 비밀번호
    business_number: str    # 사업자번호


@dataclass
class InvoiceSearchCriteria:
    """세금계산서 조회 조건"""
    start_date: date
    end_date: date
    invoice_type: str = "all"  # "sales" | "purchase" | "all"
    page: int = 1
    page_size: int = 100


class HometaxScraper:
    """
    홈택스 세금계산서 스크래퍼

    공인인증서 기반 로그인 후 세금계산서 발행/조회 수행
    """

    HOMETAX_URL = "https://www.hometax.go.kr"
    LOGIN_URL = f"{HOMETAX_URL}/websquare/websquare.wq?w2xPath=/ui/pp/index_pp.xml"
    INVOICE_URL = f"{HOMETAX_URL}/websquare/websquare.wq?w2xPath=/ui/ab/a/a/UTECAAB001.xml"

    def __init__(self, credential: HometaxCredential):
        self.credential = credential
        self.browser: Optional[Browser] = None
        self.page: Optional[Page] = None
        self._cipher: Optional[SEEDCipher] = None

    async def __aenter__(self):
        await self._init_browser()
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        await self._close_browser()

    async def _init_browser(self):
        """브라우저 초기화"""
        playwright = await async_playwright().start()
        self.browser = await playwright.chromium.launch(
            headless=True,
            args=[
                '--no-sandbox',
                '--disable-dev-shm-usage',
                '--disable-gpu',
            ]
        )
        self.page = await self.browser.new_page()

    async def _close_browser(self):
        """브라우저 종료"""
        if self.page:
            await self.page.close()
        if self.browser:
            await self.browser.close()

    async def login(self) -> bool:
        """
        공인인증서 로그인

        Returns:
            로그인 성공 여부
        """
        try:
            await self.page.goto(self.LOGIN_URL)
            await self.page.wait_for_load_state("networkidle")

            # 공인인증서 로그인 버튼 클릭
            await self.page.click("#textbox151066_input")

            # 인증서 선택 및 비밀번호 입력
            await self._select_certificate()
            await self._enter_certificate_password()

            # 로그인 완료 대기
            await self.page.wait_for_selector("#utl_head_menu_area", timeout=30000)

            return True

        except Exception as e:
            raise HometaxLoginError(f"Login failed: {e}")

    async def _select_certificate(self):
        """인증서 선택"""
        # 인증서 파일 읽기 및 SEED 복호화
        with open(self.credential.cert_path, 'rb') as f:
            encrypted_cert = f.read()

        # 인증서 비밀번호로 키 파생
        key = self._derive_key(self.credential.cert_password)
        self._cipher = SEEDCipher(key, bytes(16))

        # 복호화 및 인증서 정보 추출
        cert_data = self._cipher.decrypt(encrypted_cert)
        # ... 인증서 처리 로직

    def _derive_key(self, password: str) -> bytes:
        """비밀번호에서 암호화 키 파생"""
        import hashlib
        return hashlib.pbkdf2_hmac('sha256', password.encode(), b'salt', 1000, 16)

    async def _enter_certificate_password(self):
        """인증서 비밀번호 입력"""
        await self.page.fill("#pw", self.credential.cert_password)
        await self.page.click("#btnConfirm")

    async def search_invoices(self, criteria: InvoiceSearchCriteria) -> list[dict]:
        """
        세금계산서 목록 조회

        Args:
            criteria: 조회 조건

        Returns:
            세금계산서 목록
        """
        await self.page.goto(self.INVOICE_URL)
        await self.page.wait_for_load_state("networkidle")

        # 조회 조건 입력
        await self._set_search_criteria(criteria)

        # 조회 실행
        await self.page.click("#btnSearch")
        await self.page.wait_for_selector("#grid1", timeout=30000)

        # 결과 파싱
        return await self._parse_invoice_list()

    async def _set_search_criteria(self, criteria: InvoiceSearchCriteria):
        """조회 조건 설정"""
        # 기간 설정
        await self.page.fill("#startDate", criteria.start_date.strftime("%Y%m%d"))
        await self.page.fill("#endDate", criteria.end_date.strftime("%Y%m%d"))

        # 구분 설정
        if criteria.invoice_type == "sales":
            await self.page.click("#rbSales")
        elif criteria.invoice_type == "purchase":
            await self.page.click("#rbPurchase")

    async def _parse_invoice_list(self) -> list[dict]:
        """조회 결과 파싱"""
        invoices = []
        rows = await self.page.query_selector_all("#grid1 tbody tr")

        for row in rows:
            cells = await row.query_selector_all("td")
            invoice = {
                "nts_confirm_num": await cells[0].inner_text(),
                "issue_date": await cells[1].inner_text(),
                "supplier_brn": await cells[2].inner_text(),
                "supplier_name": await cells[3].inner_text(),
                "supply_amount": int((await cells[4].inner_text()).replace(",", "")),
                "tax_amount": int((await cells[5].inner_text()).replace(",", "")),
            }
            invoices.append(invoice)

        return invoices

    async def issue_invoice(self, invoice_data: dict) -> dict:
        """
        세금계산서 발행

        Args:
            invoice_data: 발행할 세금계산서 정보

        Returns:
            발행 결과 (국세청 승인번호 포함)
        """
        # 발행 페이지 이동
        await self.page.goto(f"{self.HOMETAX_URL}/issue")
        await self.page.wait_for_load_state("networkidle")

        # 발행 정보 입력
        await self._fill_invoice_form(invoice_data)

        # 전자서명 및 발행
        await self._sign_and_submit()

        # 결과 확인
        return await self._get_issue_result()

    async def _fill_invoice_form(self, data: dict):
        """세금계산서 양식 입력"""
        await self.page.fill("#buyerBrn", data["buyer_brn"])
        await self.page.fill("#buyerName", data["buyer_name"])
        await self.page.fill("#supplyAmount", str(data["supply_amount"]))
        await self.page.fill("#taxAmount", str(data["tax_amount"]))
        # ... 추가 필드

    async def _sign_and_submit(self):
        """전자서명 및 제출"""
        await self.page.click("#btnSign")
        # 전자서명 처리
        await self.page.click("#btnSubmit")
        await self.page.wait_for_selector("#resultArea", timeout=60000)

    async def _get_issue_result(self) -> dict:
        """발행 결과 조회"""
        nts_num = await self.page.inner_text("#ntsConfirmNum")
        return {
            "success": True,
            "nts_confirm_num": nts_num,
            "issued_at": datetime.now().isoformat(),
        }


class HometaxLoginError(Exception):
    """홈택스 로그인 오류"""
    pass


class HometaxScrapingError(Exception):
    """홈택스 스크래핑 오류"""
    pass
```

---

## 5. 데이터 계층

### 5.1 데이터베이스 구조

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Database Architecture                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                     PostgreSQL 16 Cluster                        │    │
│  │                                                                  │    │
│  │  ┌────────────────────────────────────────────────────────────┐  │    │
│  │  │                   Schema: public                           │  │    │
│  │  │                                                            │  │    │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │  │    │
│  │  │  │  companies  │  │   users     │  │   roles     │         │  │    │
│  │  │  │  (테넌트)   │──│  (사용자)   │──│  (권한)     │         │  │    │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘         │  │    │
│  │  │         │                                                   │  │    │
│  │  │         │ company_id (모든 테이블에 포함)                   │  │    │
│  │  │         ▼                                                   │  │    │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │  │    │
│  │  │  │  accounts   │  │  vouchers   │  │  invoices   │         │  │    │
│  │  │  │  (계정과목) │  │  (전표)     │  │ (세금계산서)│         │  │    │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘         │  │    │
│  │  │                                                            │  │    │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │  │    │
│  │  │  │  employees  │  │  payrolls   │  │ insurance   │         │  │    │
│  │  │  │  (사원)     │  │  (급여)     │  │ _reports    │         │  │    │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘         │  │    │
│  │  │                                                            │  │    │
│  │  │  RLS Policy: company_id = current_setting('app.tenant')    │  │    │
│  │  └────────────────────────────────────────────────────────────┘  │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 핵심 테이블 스키마

```sql
-- 세금계산서 테이블
CREATE TABLE invoices (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id      UUID NOT NULL REFERENCES companies(id),

    -- 기본 정보
    invoice_type    VARCHAR(20) NOT NULL,  -- 'sales' | 'purchase'
    issue_type      VARCHAR(20) NOT NULL,  -- 'normal' | 'reverse'
    issue_date      DATE NOT NULL,

    -- 국세청 정보
    nts_confirm_num VARCHAR(24),           -- 국세청 승인번호
    nts_send_date   TIMESTAMP,
    nts_result_code VARCHAR(10),

    -- 공급자 정보
    supplier_brn    VARCHAR(10) NOT NULL,  -- 사업자번호
    supplier_name   VARCHAR(100) NOT NULL,
    supplier_ceo    VARCHAR(50),
    supplier_addr   VARCHAR(200),

    -- 공급받는자 정보
    buyer_brn       VARCHAR(10) NOT NULL,
    buyer_name      VARCHAR(100) NOT NULL,
    buyer_ceo       VARCHAR(50),
    buyer_addr      VARCHAR(200),
    buyer_email     VARCHAR(100),

    -- 금액
    supply_amount   BIGINT NOT NULL,       -- 공급가액
    tax_amount      BIGINT NOT NULL,       -- 세액
    total_amount    BIGINT NOT NULL,       -- 합계

    -- Provider 정보
    provider        VARCHAR(20) NOT NULL,  -- 'scraper' | 'nts_api' | 'popbill'
    provider_ref    VARCHAR(100),          -- Provider 참조 ID

    -- 메타데이터
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at      TIMESTAMP,

    CONSTRAINT invoices_company_id_fk
        FOREIGN KEY (company_id) REFERENCES companies(id)
);

-- RLS 정책
ALTER TABLE invoices ENABLE ROW LEVEL SECURITY;

CREATE POLICY invoices_tenant_isolation ON invoices
    USING (company_id = current_setting('app.current_tenant')::uuid);

-- 인덱스
CREATE INDEX idx_invoices_company_date ON invoices(company_id, issue_date);
CREATE INDEX idx_invoices_nts_num ON invoices(nts_confirm_num);
CREATE INDEX idx_invoices_supplier ON invoices(supplier_brn);
CREATE INDEX idx_invoices_buyer ON invoices(buyer_brn);
```

---

## 6. 보안 아키텍처

### 6.1 인증/인가 흐름

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Authentication & Authorization                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [1] Login Request                                                      │
│  ┌──────────┐                      ┌──────────────┐                     │
│  │  Client  │ ─── POST /auth ───▶ │  Go API      │                     │
│  │          │     email/password   │  Server      │                     │
│  └──────────┘                      └──────┬───────┘                     │
│                                           │                             │
│  [2] Credential Verification              ▼                             │
│                                    ┌──────────────┐                     │
│                                    │  PostgreSQL  │                     │
│                                    │  (users)     │                     │
│                                    └──────┬───────┘                     │
│                                           │                             │
│  [3] Token Generation                     ▼                             │
│                                    ┌──────────────┐                     │
│                                    │  JWT Service │                     │
│                                    │  - Access    │                     │
│                                    │    (15min)   │                     │
│                                    │  - Refresh   │                     │
│                                    │    (7days)   │                     │
│                                    └──────┬───────┘                     │
│                                           │                             │
│  [4] Token Response                       ▼                             │
│  ┌──────────┐                      ┌──────────────┐                     │
│  │  Client  │ ◀── { tokens } ─── │  Go API      │                     │
│  └──────────┘                      └──────────────┘                     │
│                                                                         │
│  [5] Authenticated Request                                              │
│  ┌──────────┐                      ┌──────────────┐                     │
│  │  Client  │ ─ Bearer Token ──▶ │  Middleware  │                     │
│  └──────────┘                      │  - JWT Verify│                     │
│                                    │  - Tenant    │                     │
│                                    │  - RBAC      │                     │
│                                    └──────┬───────┘                     │
│                                           │                             │
│  [6] Tenant Context Injection             ▼                             │
│                                    ┌──────────────┐                     │
│                                    │ SET app.     │                     │
│                                    │ current_     │                     │
│                                    │ tenant       │                     │
│                                    └──────────────┘                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 서비스 간 보안

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Inter-Service Security                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Go API Server ◀──── mTLS + Service Token ────▶ Python Services        │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                        mTLS Configuration                        │    │
│  │                                                                  │    │
│  │  Go Client:                                                      │    │
│  │  ┌─────────────────────────────────────────────────────────┐     │    │
│  │  │ tlsConfig := &tls.Config{                               │     │    │
│  │  │     Certificates: []tls.Certificate{clientCert},        │     │    │
│  │  │     RootCAs:      caCertPool,                           │     │    │
│  │  │     ServerName:   "python-scraper",                     │     │    │
│  │  │ }                                                       │     │    │
│  │  └─────────────────────────────────────────────────────────┘     │    │
│  │                                                                  │    │
│  │  Python Server:                                                  │    │
│  │  ┌─────────────────────────────────────────────────────────┐     │    │
│  │  │ server_credentials = grpc.ssl_server_credentials(       │     │    │
│  │  │     [(private_key, certificate_chain)],                 │     │    │
│  │  │     root_certificates=ca_cert,                          │     │    │
│  │  │     require_client_auth=True                            │     │    │
│  │  │ )                                                       │     │    │
│  │  └─────────────────────────────────────────────────────────┘     │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 확장성 설계

### 7.1 수평 확장 전략

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Horizontal Scaling Strategy                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────────────────────────────────────────────┐     │
│  │                     Stateless Services                          │     │
│  │                                                                 │     │
│  │  Go API Server                    Python Services               │     │
│  │  ┌─────┐ ┌─────┐ ┌─────┐         ┌─────┐ ┌─────┐              │     │
│  │  │ Pod │ │ Pod │ │ Pod │         │ Pod │ │ Pod │              │     │
│  │  └─────┘ └─────┘ └─────┘         └─────┘ └─────┘              │     │
│  │       ▲                               ▲                        │     │
│  │       │                               │                        │     │
│  │  HPA: CPU 70% → Scale Up         HPA: Queue Length            │     │
│  │       Min: 3, Max: 20                 Min: 2, Max: 10          │     │
│  └────────────────────────────────────────────────────────────────┘     │
│                                                                         │
│  ┌────────────────────────────────────────────────────────────────┐     │
│  │                     Stateful Services                           │     │
│  │                                                                 │     │
│  │  PostgreSQL (Patroni)              Redis Cluster               │     │
│  │  ┌─────────┐                       ┌─────┐ ┌─────┐ ┌─────┐    │     │
│  │  │ Primary │───▶ Replica 1         │ M1  │ │ M2  │ │ M3  │    │     │
│  │  └─────────┘     Replica 2         └──┬──┘ └──┬──┘ └──┬──┘    │     │
│  │                                       │       │       │        │     │
│  │  Automatic Failover                   └───────┴───────┘        │     │
│  │  pg_basebackup for Replicas           Hash Slot Distribution   │     │
│  └────────────────────────────────────────────────────────────────┘     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.2 캐시 전략

| 데이터 유형 | 캐시 위치 | TTL | 갱신 전략 |
|------------|----------|-----|----------|
| 사용자 세션 | Redis | 15분 | Sliding |
| 계정과목 | Redis | 1시간 | Write-through |
| 거래처 목록 | Redis | 30분 | Write-through |
| 세금계산서 | Local + Redis | 5분 | Cache-aside |

---

**다음 문서**: [02_세금계산서_연동_설계.md](./02_세금계산서_연동_설계.md)
