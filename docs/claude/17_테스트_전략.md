# 17. 테스트 전략

## 개요

K-ERP 시스템의 품질 보증을 위한 테스트 전략 문서.
Go 백엔드 + React 프론트엔드 테스트 자동화 전략.

### 테스트 목표

| 항목 | 목표 | 비고 |
|------|------|------|
| 코드 커버리지 | 80%+ | 핵심 비즈니스 로직 필수 |
| API 테스트 | 100% 엔드포인트 | E2E 포함 |
| 성능 테스트 | p95 < 200ms | API 응답 시간 |
| 보안 테스트 | OWASP Top 10 | 취약점 스캔 |

---

## 1. 테스트 피라미드

```
                    ┌─────────────┐
                    │    E2E      │  ← 적게 (느림, 비용 높음)
                    │  10% 비중   │
                ┌───┴─────────────┴───┐
                │    Integration      │  ← 중간
                │      30% 비중       │
            ┌───┴─────────────────────┴───┐
            │          Unit Tests          │  ← 많이 (빠름, 비용 낮음)
            │           60% 비중           │
            └─────────────────────────────────┘
```

### 테스트 유형별 목적

| 유형 | 범위 | 도구 | 목적 |
|------|------|------|------|
| Unit | 함수/메서드 | `go test`, Jest | 로직 검증 |
| Integration | 모듈 간 | testcontainers | DB/Redis 연동 |
| E2E | 전체 시스템 | Playwright | 사용자 시나리오 |
| Contract | API 스펙 | Pact | 서비스 계약 |

---

## 2. Go 백엔드 테스트

### 2.1 테스트 디렉토리 구조

```
backend/
├── internal/
│   ├── domain/
│   │   ├── voucher.go
│   │   └── voucher_test.go          # 도메인 로직 단위 테스트
│   ├── service/
│   │   ├── voucher_service.go
│   │   └── voucher_service_test.go  # 서비스 단위 테스트
│   ├── repository/
│   │   ├── voucher_repo.go
│   │   └── voucher_repo_test.go     # 통합 테스트 (실제 DB)
│   └── handler/
│       ├── voucher_handler.go
│       └── voucher_handler_test.go  # HTTP 핸들러 테스트
├── test/
│   ├── integration/                  # 통합 테스트
│   │   ├── accounting_test.go
│   │   └── tax_invoice_test.go
│   ├── e2e/                          # E2E 테스트
│   │   └── api_e2e_test.go
│   ├── fixtures/                     # 테스트 데이터
│   │   ├── companies.json
│   │   └── vouchers.json
│   └── testutil/                     # 테스트 유틸리티
│       ├── db.go
│       ├── factory.go
│       └── mock.go
└── Makefile
```

### 2.2 단위 테스트

```go
// internal/domain/voucher_test.go
package domain_test

import (
    "testing"
    "time"

    "github.com/google/uuid"
    "github.com/shopspring/decimal"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"

    "kerp/internal/domain"
)

func TestVoucher_Validate(t *testing.T) {
    tests := []struct {
        name        string
        voucher     *domain.Voucher
        expectError bool
        errorMsg    string
    }{
        {
            name: "valid_voucher_balanced",
            voucher: &domain.Voucher{
                ID:          uuid.New(),
                CompanyID:   uuid.New(),
                VoucherDate: time.Now(),
                VoucherType: domain.VoucherTypeGeneral,
                Lines: []domain.VoucherLine{
                    {
                        AccountCode: "101",
                        DebitAmount: decimal.NewFromInt(100000),
                        CreditAmount: decimal.Zero,
                    },
                    {
                        AccountCode: "401",
                        DebitAmount: decimal.Zero,
                        CreditAmount: decimal.NewFromInt(100000),
                    },
                },
            },
            expectError: false,
        },
        {
            name: "invalid_voucher_unbalanced",
            voucher: &domain.Voucher{
                ID:          uuid.New(),
                CompanyID:   uuid.New(),
                VoucherDate: time.Now(),
                VoucherType: domain.VoucherTypeGeneral,
                Lines: []domain.VoucherLine{
                    {
                        AccountCode: "101",
                        DebitAmount: decimal.NewFromInt(100000),
                        CreditAmount: decimal.Zero,
                    },
                    {
                        AccountCode: "401",
                        DebitAmount: decimal.Zero,
                        CreditAmount: decimal.NewFromInt(50000), // 불균형
                    },
                },
            },
            expectError: true,
            errorMsg:    "voucher is not balanced",
        },
        {
            name: "invalid_voucher_no_lines",
            voucher: &domain.Voucher{
                ID:          uuid.New(),
                CompanyID:   uuid.New(),
                VoucherDate: time.Now(),
                VoucherType: domain.VoucherTypeGeneral,
                Lines:       []domain.VoucherLine{},
            },
            expectError: true,
            errorMsg:    "voucher must have at least one line",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            err := tt.voucher.Validate()

            if tt.expectError {
                require.Error(t, err)
                assert.Contains(t, err.Error(), tt.errorMsg)
            } else {
                require.NoError(t, err)
            }
        })
    }
}

func TestVoucher_CalculateTotals(t *testing.T) {
    voucher := &domain.Voucher{
        Lines: []domain.VoucherLine{
            {DebitAmount: decimal.NewFromInt(100000), CreditAmount: decimal.Zero},
            {DebitAmount: decimal.NewFromInt(50000), CreditAmount: decimal.Zero},
            {DebitAmount: decimal.Zero, CreditAmount: decimal.NewFromInt(150000)},
        },
    }

    totalDebit, totalCredit := voucher.CalculateTotals()

    assert.True(t, totalDebit.Equal(decimal.NewFromInt(150000)))
    assert.True(t, totalCredit.Equal(decimal.NewFromInt(150000)))
}
```

### 2.3 서비스 단위 테스트 (Mock 사용)

```go
// internal/service/voucher_service_test.go
package service_test

import (
    "context"
    "testing"

    "github.com/google/uuid"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
    "github.com/stretchr/testify/require"

    "kerp/internal/domain"
    "kerp/internal/service"
)

// Mock Repository
type MockVoucherRepository struct {
    mock.Mock
}

func (m *MockVoucherRepository) Create(ctx context.Context, voucher *domain.Voucher) error {
    args := m.Called(ctx, voucher)
    return args.Error(0)
}

func (m *MockVoucherRepository) FindByID(ctx context.Context, id uuid.UUID) (*domain.Voucher, error) {
    args := m.Called(ctx, id)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*domain.Voucher), args.Error(1)
}

func (m *MockVoucherRepository) FindByCompany(ctx context.Context, companyID uuid.UUID, filter domain.VoucherFilter) ([]domain.Voucher, error) {
    args := m.Called(ctx, companyID, filter)
    return args.Get(0).([]domain.Voucher), args.Error(1)
}

func (m *MockVoucherRepository) Update(ctx context.Context, voucher *domain.Voucher) error {
    args := m.Called(ctx, voucher)
    return args.Error(0)
}

func (m *MockVoucherRepository) Delete(ctx context.Context, id uuid.UUID) error {
    args := m.Called(ctx, id)
    return args.Error(0)
}

func TestVoucherService_CreateVoucher(t *testing.T) {
    ctx := context.Background()
    mockRepo := new(MockVoucherRepository)
    svc := service.NewVoucherService(mockRepo)

    t.Run("success", func(t *testing.T) {
        input := &service.CreateVoucherInput{
            CompanyID:   uuid.New(),
            VoucherDate: "2024-01-15",
            VoucherType: "general",
            Description: "매출 전표",
            Lines: []service.VoucherLineInput{
                {AccountCode: "101", DebitAmount: 100000, CreditAmount: 0},
                {AccountCode: "401", DebitAmount: 0, CreditAmount: 100000},
            },
        }

        mockRepo.On("Create", ctx, mock.AnythingOfType("*domain.Voucher")).Return(nil)

        voucher, err := svc.CreateVoucher(ctx, input)

        require.NoError(t, err)
        assert.NotNil(t, voucher)
        assert.Equal(t, input.CompanyID, voucher.CompanyID)
        mockRepo.AssertExpectations(t)
    })

    t.Run("validation_error_unbalanced", func(t *testing.T) {
        input := &service.CreateVoucherInput{
            CompanyID:   uuid.New(),
            VoucherDate: "2024-01-15",
            VoucherType: "general",
            Lines: []service.VoucherLineInput{
                {AccountCode: "101", DebitAmount: 100000, CreditAmount: 0},
                {AccountCode: "401", DebitAmount: 0, CreditAmount: 50000}, // 불균형
            },
        }

        voucher, err := svc.CreateVoucher(ctx, input)

        require.Error(t, err)
        assert.Nil(t, voucher)
        assert.Contains(t, err.Error(), "balanced")
    })
}
```

### 2.4 통합 테스트 (testcontainers)

```go
// test/integration/accounting_test.go
package integration_test

import (
    "context"
    "testing"
    "time"

    "github.com/stretchr/testify/suite"
    "github.com/testcontainers/testcontainers-go"
    "github.com/testcontainers/testcontainers-go/modules/postgres"
    "github.com/testcontainers/testcontainers-go/modules/redis"
    "gorm.io/driver/postgres"
    "gorm.io/gorm"

    "kerp/internal/domain"
    "kerp/internal/repository"
    "kerp/internal/service"
)

type AccountingIntegrationSuite struct {
    suite.Suite
    ctx            context.Context
    pgContainer    *postgres.PostgresContainer
    redisContainer *redis.RedisContainer
    db             *gorm.DB
    voucherRepo    *repository.VoucherRepository
    voucherSvc     *service.VoucherService
}

func (s *AccountingIntegrationSuite) SetupSuite() {
    s.ctx = context.Background()

    // PostgreSQL 컨테이너 시작
    pgContainer, err := postgres.RunContainer(s.ctx,
        testcontainers.WithImage("postgres:16-alpine"),
        postgres.WithDatabase("kerp_test"),
        postgres.WithUsername("test"),
        postgres.WithPassword("test"),
    )
    s.Require().NoError(err)
    s.pgContainer = pgContainer

    // Redis 컨테이너 시작
    redisContainer, err := redis.RunContainer(s.ctx,
        testcontainers.WithImage("redis:7-alpine"),
    )
    s.Require().NoError(err)
    s.redisContainer = redisContainer

    // DB 연결
    connStr, err := pgContainer.ConnectionString(s.ctx, "sslmode=disable")
    s.Require().NoError(err)

    db, err := gorm.Open(postgres.Open(connStr), &gorm.Config{})
    s.Require().NoError(err)
    s.db = db

    // 마이그레이션 실행
    err = db.AutoMigrate(
        &domain.Company{},
        &domain.Account{},
        &domain.Voucher{},
        &domain.VoucherLine{},
    )
    s.Require().NoError(err)

    // Repository & Service 초기화
    s.voucherRepo = repository.NewVoucherRepository(db)
    s.voucherSvc = service.NewVoucherService(s.voucherRepo)
}

func (s *AccountingIntegrationSuite) TearDownSuite() {
    if s.pgContainer != nil {
        s.pgContainer.Terminate(s.ctx)
    }
    if s.redisContainer != nil {
        s.redisContainer.Terminate(s.ctx)
    }
}

func (s *AccountingIntegrationSuite) SetupTest() {
    // 테스트 전 데이터 정리
    s.db.Exec("TRUNCATE TABLE voucher_lines, vouchers, accounts, companies CASCADE")
}

func (s *AccountingIntegrationSuite) TestCreateAndFindVoucher() {
    // Given: 테스트 회사 생성
    company := &domain.Company{
        Name:           "테스트 회사",
        BusinessNumber: "1234567890",
    }
    s.Require().NoError(s.db.Create(company).Error)

    // When: 전표 생성
    input := &service.CreateVoucherInput{
        CompanyID:   company.ID,
        VoucherDate: time.Now().Format("2006-01-02"),
        VoucherType: "general",
        Description: "통합테스트 전표",
        Lines: []service.VoucherLineInput{
            {AccountCode: "101", DebitAmount: 100000, CreditAmount: 0},
            {AccountCode: "401", DebitAmount: 0, CreditAmount: 100000},
        },
    }

    created, err := s.voucherSvc.CreateVoucher(s.ctx, input)
    s.Require().NoError(err)

    // Then: 전표 조회 검증
    found, err := s.voucherRepo.FindByID(s.ctx, created.ID)
    s.Require().NoError(err)
    s.Equal(company.ID, found.CompanyID)
    s.Equal("통합테스트 전표", found.Description)
    s.Len(found.Lines, 2)
}

func (s *AccountingIntegrationSuite) TestVoucherBalanceValidation() {
    // Given: 테스트 회사
    company := &domain.Company{
        Name:           "테스트 회사",
        BusinessNumber: "1234567890",
    }
    s.Require().NoError(s.db.Create(company).Error)

    // When: 불균형 전표 생성 시도
    input := &service.CreateVoucherInput{
        CompanyID:   company.ID,
        VoucherDate: time.Now().Format("2006-01-02"),
        VoucherType: "general",
        Lines: []service.VoucherLineInput{
            {AccountCode: "101", DebitAmount: 100000, CreditAmount: 0},
            {AccountCode: "401", DebitAmount: 0, CreditAmount: 50000},
        },
    }

    // Then: 오류 발생
    _, err := s.voucherSvc.CreateVoucher(s.ctx, input)
    s.Require().Error(err)
    s.Contains(err.Error(), "balanced")
}

func TestAccountingIntegration(t *testing.T) {
    if testing.Short() {
        t.Skip("Skipping integration test in short mode")
    }
    suite.Run(t, new(AccountingIntegrationSuite))
}
```

### 2.5 HTTP 핸들러 테스트

```go
// internal/handler/voucher_handler_test.go
package handler_test

import (
    "bytes"
    "encoding/json"
    "net/http"
    "net/http/httptest"
    "testing"

    "github.com/gin-gonic/gin"
    "github.com/google/uuid"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
    "github.com/stretchr/testify/require"

    "kerp/internal/handler"
)

func setupRouter(h *handler.VoucherHandler) *gin.Engine {
    gin.SetMode(gin.TestMode)
    r := gin.New()

    api := r.Group("/api/v1")
    api.POST("/vouchers", h.Create)
    api.GET("/vouchers/:id", h.GetByID)
    api.GET("/vouchers", h.List)

    return r
}

func TestVoucherHandler_Create(t *testing.T) {
    mockSvc := new(MockVoucherService)
    h := handler.NewVoucherHandler(mockSvc)
    router := setupRouter(h)

    t.Run("success", func(t *testing.T) {
        companyID := uuid.New()
        reqBody := map[string]interface{}{
            "voucher_date": "2024-01-15",
            "voucher_type": "general",
            "description":  "테스트 전표",
            "lines": []map[string]interface{}{
                {"account_code": "101", "debit_amount": 100000, "credit_amount": 0},
                {"account_code": "401", "debit_amount": 0, "credit_amount": 100000},
            },
        }

        mockSvc.On("CreateVoucher", mock.Anything, mock.AnythingOfType("*service.CreateVoucherInput")).
            Return(&domain.Voucher{ID: uuid.New(), CompanyID: companyID}, nil)

        body, _ := json.Marshal(reqBody)
        req := httptest.NewRequest(http.MethodPost, "/api/v1/vouchers", bytes.NewBuffer(body))
        req.Header.Set("Content-Type", "application/json")
        req.Header.Set("X-Company-ID", companyID.String())

        w := httptest.NewRecorder()
        router.ServeHTTP(w, req)

        assert.Equal(t, http.StatusCreated, w.Code)

        var response map[string]interface{}
        err := json.Unmarshal(w.Body.Bytes(), &response)
        require.NoError(t, err)
        assert.NotEmpty(t, response["id"])
    })

    t.Run("validation_error", func(t *testing.T) {
        reqBody := map[string]interface{}{
            "voucher_date": "invalid-date",
            "voucher_type": "general",
        }

        body, _ := json.Marshal(reqBody)
        req := httptest.NewRequest(http.MethodPost, "/api/v1/vouchers", bytes.NewBuffer(body))
        req.Header.Set("Content-Type", "application/json")
        req.Header.Set("X-Company-ID", uuid.New().String())

        w := httptest.NewRecorder()
        router.ServeHTTP(w, req)

        assert.Equal(t, http.StatusBadRequest, w.Code)
    })
}
```

---

## 3. React 프론트엔드 테스트

### 3.1 테스트 도구

| 도구 | 용도 |
|------|------|
| Vitest | 단위/통합 테스트 러너 |
| React Testing Library | 컴포넌트 테스트 |
| MSW (Mock Service Worker) | API 모킹 |
| Playwright | E2E 테스트 |

### 3.2 Vitest 설정

```typescript
// web/vitest.config.ts
import { defineConfig } from 'vitest/config'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./src/test/setup.ts'],
    include: ['src/**/*.{test,spec}.{ts,tsx}'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'src/test/',
        '**/*.d.ts',
        '**/*.config.*',
      ],
      thresholds: {
        branches: 70,
        functions: 70,
        lines: 70,
        statements: 70,
      },
    },
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
})
```

### 3.3 테스트 셋업

```typescript
// web/src/test/setup.ts
import '@testing-library/jest-dom'
import { cleanup } from '@testing-library/react'
import { afterEach, beforeAll, afterAll } from 'vitest'
import { server } from './mocks/server'

// MSW 서버 시작
beforeAll(() => server.listen({ onUnhandledRequest: 'error' }))
afterEach(() => {
  cleanup()
  server.resetHandlers()
})
afterAll(() => server.close())
```

### 3.4 MSW API 모킹

```typescript
// web/src/test/mocks/handlers.ts
import { http, HttpResponse } from 'msw'

export const handlers = [
  // 전표 목록 조회
  http.get('/api/v1/vouchers', () => {
    return HttpResponse.json({
      data: [
        {
          id: '550e8400-e29b-41d4-a716-446655440001',
          voucher_no: 'V-2024-0001',
          voucher_date: '2024-01-15',
          voucher_type: 'general',
          description: '매출 전표',
          total_debit: 100000,
          total_credit: 100000,
        },
      ],
      meta: {
        total: 1,
        page: 1,
        limit: 20,
      },
    })
  }),

  // 전표 생성
  http.post('/api/v1/vouchers', async ({ request }) => {
    const body = await request.json()
    return HttpResponse.json({
      id: '550e8400-e29b-41d4-a716-446655440002',
      ...body,
    }, { status: 201 })
  }),

  // 전표 상세 조회
  http.get('/api/v1/vouchers/:id', ({ params }) => {
    return HttpResponse.json({
      id: params.id,
      voucher_no: 'V-2024-0001',
      voucher_date: '2024-01-15',
      voucher_type: 'general',
      description: '매출 전표',
      lines: [
        { account_code: '101', account_name: '현금', debit_amount: 100000, credit_amount: 0 },
        { account_code: '401', account_name: '매출', debit_amount: 0, credit_amount: 100000 },
      ],
    })
  }),
]

// web/src/test/mocks/server.ts
import { setupServer } from 'msw/node'
import { handlers } from './handlers'

export const server = setupServer(...handlers)
```

### 3.5 컴포넌트 단위 테스트

```typescript
// web/src/components/voucher/VoucherForm.test.tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { describe, it, expect, vi } from 'vitest'
import { VoucherForm } from './VoucherForm'
import { QueryClientProvider, QueryClient } from '@tanstack/react-query'

const queryClient = new QueryClient({
  defaultOptions: {
    queries: { retry: false },
    mutations: { retry: false },
  },
})

const wrapper = ({ children }: { children: React.ReactNode }) => (
  <QueryClientProvider client={queryClient}>
    {children}
  </QueryClientProvider>
)

describe('VoucherForm', () => {
  it('renders form fields correctly', () => {
    render(<VoucherForm />, { wrapper })

    expect(screen.getByLabelText(/전표일자/i)).toBeInTheDocument()
    expect(screen.getByLabelText(/전표유형/i)).toBeInTheDocument()
    expect(screen.getByLabelText(/적요/i)).toBeInTheDocument()
    expect(screen.getByRole('button', { name: /저장/i })).toBeInTheDocument()
  })

  it('validates required fields on submit', async () => {
    render(<VoucherForm />, { wrapper })

    const submitButton = screen.getByRole('button', { name: /저장/i })
    await userEvent.click(submitButton)

    await waitFor(() => {
      expect(screen.getByText(/전표일자를 입력하세요/i)).toBeInTheDocument()
    })
  })

  it('calls onSubmit with form data', async () => {
    const onSubmit = vi.fn()
    render(<VoucherForm onSubmit={onSubmit} />, { wrapper })

    // 폼 입력
    await userEvent.type(screen.getByLabelText(/전표일자/i), '2024-01-15')
    await userEvent.selectOptions(screen.getByLabelText(/전표유형/i), 'general')
    await userEvent.type(screen.getByLabelText(/적요/i), '테스트 전표')

    // 제출
    await userEvent.click(screen.getByRole('button', { name: /저장/i }))

    await waitFor(() => {
      expect(onSubmit).toHaveBeenCalledWith(
        expect.objectContaining({
          voucher_date: '2024-01-15',
          voucher_type: 'general',
          description: '테스트 전표',
        })
      )
    })
  })

  it('displays balance error when debit != credit', async () => {
    render(<VoucherForm />, { wrapper })

    // 차변만 입력 (불균형)
    const debitInput = screen.getByTestId('line-0-debit')
    await userEvent.type(debitInput, '100000')

    await waitFor(() => {
      expect(screen.getByText(/차대 불균형/i)).toBeInTheDocument()
    })
  })
})
```

### 3.6 커스텀 훅 테스트

```typescript
// web/src/hooks/useVouchers.test.ts
import { renderHook, waitFor } from '@testing-library/react'
import { QueryClientProvider, QueryClient } from '@tanstack/react-query'
import { describe, it, expect } from 'vitest'
import { useVouchers } from './useVouchers'

const queryClient = new QueryClient({
  defaultOptions: {
    queries: { retry: false },
  },
})

const wrapper = ({ children }: { children: React.ReactNode }) => (
  <QueryClientProvider client={queryClient}>
    {children}
  </QueryClientProvider>
)

describe('useVouchers', () => {
  it('fetches voucher list', async () => {
    const { result } = renderHook(() => useVouchers(), { wrapper })

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true)
    })

    expect(result.current.data?.data).toHaveLength(1)
    expect(result.current.data?.data[0].voucher_no).toBe('V-2024-0001')
  })

  it('handles pagination', async () => {
    const { result } = renderHook(
      () => useVouchers({ page: 2, limit: 10 }),
      { wrapper }
    )

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true)
    })
  })
})
```

---

## 4. E2E 테스트 (Playwright)

### 4.1 Playwright 설정

```typescript
// web/playwright.config.ts
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: [
    ['html'],
    ['json', { outputFile: 'test-results/results.json' }],
  ],
  use: {
    baseURL: process.env.BASE_URL || 'http://localhost:5173',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'mobile',
      use: { ...devices['iPhone 13'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI,
  },
})
```

### 4.2 E2E 테스트 시나리오

```typescript
// web/e2e/voucher.spec.ts
import { test, expect } from '@playwright/test'

test.describe('전표 관리', () => {
  test.beforeEach(async ({ page }) => {
    // 로그인
    await page.goto('/login')
    await page.fill('[name="email"]', 'test@example.com')
    await page.fill('[name="password"]', 'password123')
    await page.click('button[type="submit"]')
    await expect(page).toHaveURL('/dashboard')
  })

  test('전표 목록 조회', async ({ page }) => {
    await page.goto('/accounting/vouchers')

    // 테이블 로딩 대기
    await expect(page.locator('table')).toBeVisible()

    // 전표 데이터 확인
    const rows = page.locator('table tbody tr')
    await expect(rows).toHaveCount.greaterThan(0)
  })

  test('전표 생성', async ({ page }) => {
    await page.goto('/accounting/vouchers/new')

    // 폼 입력
    await page.fill('[name="voucher_date"]', '2024-01-15')
    await page.selectOption('[name="voucher_type"]', 'general')
    await page.fill('[name="description"]', 'E2E 테스트 전표')

    // 전표 라인 입력
    await page.fill('[data-testid="line-0-account"]', '101')
    await page.fill('[data-testid="line-0-debit"]', '100000')

    await page.click('button[data-testid="add-line"]')
    await page.fill('[data-testid="line-1-account"]', '401')
    await page.fill('[data-testid="line-1-credit"]', '100000')

    // 저장
    await page.click('button[type="submit"]')

    // 성공 확인
    await expect(page.locator('.toast-success')).toBeVisible()
    await expect(page).toHaveURL(/\/accounting\/vouchers\/[a-f0-9-]+/)
  })

  test('차대 불균형 시 저장 불가', async ({ page }) => {
    await page.goto('/accounting/vouchers/new')

    await page.fill('[name="voucher_date"]', '2024-01-15')
    await page.fill('[data-testid="line-0-account"]', '101')
    await page.fill('[data-testid="line-0-debit"]', '100000')
    // credit 없이 저장 시도

    await page.click('button[type="submit"]')

    // 에러 메시지 확인
    await expect(page.locator('.error-message')).toContainText('차대 불균형')
  })
})

test.describe('세금계산서 발행', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/login')
    await page.fill('[name="email"]', 'test@example.com')
    await page.fill('[name="password"]', 'password123')
    await page.click('button[type="submit"]')
  })

  test('세금계산서 발행 흐름', async ({ page }) => {
    await page.goto('/tax/invoices/new')

    // 공급자 정보는 자동 입력
    await expect(page.locator('[name="supplier_name"]')).toHaveValue(/테스트/)

    // 공급받는자 정보 입력
    await page.fill('[name="buyer_business_number"]', '1234567890')
    await page.click('button[data-testid="search-buyer"]')
    await page.click('[data-testid="buyer-result-0"]')

    // 품목 입력
    await page.fill('[data-testid="item-0-name"]', '상품A')
    await page.fill('[data-testid="item-0-quantity"]', '10')
    await page.fill('[data-testid="item-0-unit-price"]', '10000')

    // 금액 자동 계산 확인
    await expect(page.locator('[data-testid="supply-amount"]')).toHaveValue('100000')
    await expect(page.locator('[data-testid="tax-amount"]')).toHaveValue('10000')

    // 발행
    await page.click('button[data-testid="issue-invoice"]')

    // 확인 다이얼로그
    await page.click('button[data-testid="confirm-issue"]')

    // 성공
    await expect(page.locator('.toast-success')).toContainText('발행 완료')
  })
})
```

---

## 5. 특수 테스트

### 5.1 회계 정합성 테스트

```go
// test/accounting/integrity_test.go
package accounting_test

import (
    "testing"
    "github.com/stretchr/testify/suite"
)

type AccountingIntegritySuite struct {
    suite.Suite
    db *gorm.DB
}

func (s *AccountingIntegritySuite) TestDoubleEntryBalance() {
    // 모든 전표의 차변 합 = 대변 합 검증
    var result struct {
        TotalDebit  decimal.Decimal
        TotalCredit decimal.Decimal
    }

    s.db.Raw(`
        SELECT
            COALESCE(SUM(debit_amount), 0) as total_debit,
            COALESCE(SUM(credit_amount), 0) as total_credit
        FROM voucher_lines
        WHERE deleted_at IS NULL
    `).Scan(&result)

    s.True(result.TotalDebit.Equal(result.TotalCredit),
        "차변 합(%s)과 대변 합(%s)이 일치하지 않음",
        result.TotalDebit.String(), result.TotalCredit.String())
}

func (s *AccountingIntegritySuite) TestAccountBalanceConsistency() {
    // 각 계정의 잔액 = 원장 집계 결과
    // 계정별 잔액 검증 로직
}

func (s *AccountingIntegritySuite) TestTrialBalanceZero() {
    // 시산표 차대 일치 검증
    var result struct {
        DebitBalance  decimal.Decimal
        CreditBalance decimal.Decimal
    }

    s.db.Raw(`
        SELECT
            COALESCE(SUM(CASE WHEN balance_type = 'debit' THEN balance ELSE 0 END), 0) as debit_balance,
            COALESCE(SUM(CASE WHEN balance_type = 'credit' THEN balance ELSE 0 END), 0) as credit_balance
        FROM account_balances
        WHERE period = ?
    `, "2024-01").Scan(&result)

    s.True(result.DebitBalance.Equal(result.CreditBalance))
}
```

### 5.2 4대보험 계산 테스트

```go
// test/hr/insurance_test.go
package hr_test

import (
    "testing"
    "github.com/shopspring/decimal"
)

func TestNationalPensionCalculation(t *testing.T) {
    tests := []struct {
        name         string
        salary       int64
        expectedRate decimal.Decimal
        expectedAmt  int64
    }{
        {
            name:         "일반 급여",
            salary:       3000000,
            expectedRate: decimal.NewFromFloat(0.045),
            expectedAmt:  135000,
        },
        {
            name:         "상한선 초과",
            salary:       6000000,
            expectedRate: decimal.NewFromFloat(0.045),
            expectedAmt:  248850, // 상한 기준월소득 5,530,000원 적용
        },
        {
            name:         "하한선 미만",
            salary:       300000,
            expectedRate: decimal.NewFromFloat(0.045),
            expectedAmt:  16200, // 하한 기준월소득 360,000원 적용
        },
    }

    calc := insurance.NewNationalPensionCalculator(2024)

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            result := calc.Calculate(decimal.NewFromInt(tt.salary))

            assert.Equal(t, tt.expectedAmt, result.EmployeeAmount.IntPart())
            assert.Equal(t, tt.expectedAmt, result.EmployerAmount.IntPart())
        })
    }
}

func TestHealthInsuranceCalculation(t *testing.T) {
    // 건강보험 계산 테스트
    // 장기요양보험 포함
}

func TestEmploymentInsuranceCalculation(t *testing.T) {
    // 고용보험 계산 테스트
    // 사업장 규모별 요율 차이
}
```

---

## 6. 테스트 자동화

### 6.1 테스트 명령어 (Makefile)

```makefile
# Makefile

# ============ 테스트 명령어 ============

.PHONY: test test-unit test-integration test-e2e test-coverage

# 전체 테스트
test:
	@echo "Running all tests..."
	@make test-unit
	@make test-integration

# 단위 테스트 (빠름)
test-unit:
	@echo "Running unit tests..."
	cd backend && go test -v -race -short ./...
	cd web && npm run test:unit

# 통합 테스트 (testcontainers)
test-integration:
	@echo "Running integration tests..."
	cd backend && go test -v -race -run Integration ./test/integration/...

# E2E 테스트 (Playwright)
test-e2e:
	@echo "Running E2E tests..."
	cd web && npm run test:e2e

# 커버리지 리포트
test-coverage:
	@echo "Generating coverage report..."
	cd backend && go test -coverprofile=coverage.out -covermode=atomic ./...
	cd backend && go tool cover -html=coverage.out -o coverage.html
	cd web && npm run test:coverage

# 특정 패키지 테스트
test-pkg:
	@read -p "Package path: " pkg; \
	cd backend && go test -v -race ./$$pkg/...

# 회계 정합성 테스트
test-accounting:
	@echo "Running accounting integrity tests..."
	cd backend && go test -v -run Integrity ./test/accounting/...

# 보안 테스트 (gosec)
test-security:
	@echo "Running security tests..."
	cd backend && gosec -fmt=json -out=security-report.json ./...
```

### 6.2 CI 테스트 워크플로우

```yaml
# .github/workflows/test.yml
name: Test

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: kerp_test
        ports: ['5432:5432']
        options: --health-cmd pg_isready --health-interval 10s
      redis:
        image: redis:7-alpine
        ports: ['6379:6379']

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Run tests
        run: |
          cd backend
          go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.out
          flags: backend

  frontend-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: cd web && npm ci

      - name: Run tests
        run: cd web && npm run test:coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./web/coverage/lcov.info
          flags: frontend

  e2e-test:
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    steps:
      - uses: actions/checkout@v4

      - name: Setup
        run: |
          docker compose -f docker-compose.test.yml up -d
          cd web && npm ci
          npx playwright install --with-deps

      - name: Run E2E tests
        run: cd web && npm run test:e2e

      - name: Upload artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: web/playwright-report/
```

---

## 7. 테스트 품질 지표

### 7.1 목표 지표

| 지표 | 목표 | 현재 | 비고 |
|------|------|------|------|
| 코드 커버리지 | 80% | - | 핵심 로직 필수 |
| 브랜치 커버리지 | 70% | - | 조건문 분기 |
| 테스트 통과율 | 100% | - | CI 필수 조건 |
| 테스트 실행 시간 | < 10분 | - | 단위 테스트 기준 |

### 7.2 테스트 리포트

```yaml
# 테스트 결과 대시보드 구성
Grafana Dashboard:
  - Test Pass Rate (%)
  - Code Coverage Trend
  - Test Execution Time
  - Failed Test History
  - Flaky Test Detection
```

---

**문서 버전**: 1.0
**작성일**: 2025년 1월
**작성자**: K-ERP 개발팀
