# 19. ë°°í¬ ë° ìš´ì˜ ê°€ì´ë“œ

## ê°œìš”

K-ERP ì‹œìŠ¤í…œì˜ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ë° ìš´ì˜ ê°€ì´ë“œ.
Kubernetes ê¸°ë°˜ ì»¨í…Œì´ë„ˆ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ í™˜ê²½.

### ë°°í¬ í™˜ê²½

| í™˜ê²½ | ìš©ë„ | URL | ë¹„ê³  |
|------|------|-----|------|
| Development | ê°œë°œ/í…ŒìŠ¤íŠ¸ | dev.kerp.example.com | ìë™ ë°°í¬ |
| Staging | QA/UAT | staging.kerp.example.com | ìë™ ë°°í¬ |
| Production | ì‹¤ì„œë¹„ìŠ¤ | api.kerp.example.com | ìˆ˜ë™ ìŠ¹ì¸ |

---

## 1. ì¸í”„ë¼ ì•„í‚¤í…ì²˜

### 1.1 AWS ì¸í”„ë¼ êµ¬ì„±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            AWS Cloud                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                         VPC (10.0.0.0/16)                        â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚                     Public Subnet                            â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚   ALB   â”‚  â”‚   NAT   â”‚  â”‚         Bastion             â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚ (HTTPS) â”‚  â”‚ Gateway â”‚  â”‚                             â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚          â”‚                                                       â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚       â”‚           Private Subnet                            â”‚â”‚â”‚
â”‚  â”‚  â”‚       â–¼                                                      â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚                 EKS Cluster                          â”‚   â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  â”‚ API Pod â”‚ â”‚ API Pod â”‚ â”‚ Worker  â”‚ â”‚ Worker  â”‚   â”‚   â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  (x3)   â”‚ â”‚  (x3)   â”‚ â”‚  Pod    â”‚ â”‚  Pod    â”‚   â”‚   â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                              â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚ RDS Postgresâ”‚  â”‚ ElastiCache â”‚  â”‚     OpenSearch  â”‚    â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  (Primary)  â”‚  â”‚   (Redis)   â”‚  â”‚   (Meilisearch) â”‚    â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  (Standby)  â”‚  â”‚   Cluster   â”‚  â”‚                 â”‚    â”‚â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     S3      â”‚  â”‚ CloudFront  â”‚  â”‚        Route 53             â”‚  â”‚
â”‚  â”‚  (Storage)  â”‚  â”‚    (CDN)    â”‚  â”‚         (DNS)               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Kubernetes ë¦¬ì†ŒìŠ¤

```yaml
# deployments/k8s/production/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: kerp-prod
  labels:
    app: kerp
    env: production
---
# Resource Quotas
apiVersion: v1
kind: ResourceQuota
metadata:
  name: kerp-quota
  namespace: kerp-prod
spec:
  hard:
    requests.cpu: "20"
    requests.memory: 40Gi
    limits.cpu: "40"
    limits.memory: 80Gi
    pods: "50"
```

---

## 2. Docker ì´ë¯¸ì§€ ë¹Œë“œ

### 2.1 ë©€í‹°ìŠ¤í…Œì´ì§€ Dockerfile

```dockerfile
# backend/Dockerfile
# ============ Build Stage ============
FROM golang:1.22-alpine AS builder

WORKDIR /app

# ì˜ì¡´ì„± ìºì‹±
COPY go.mod go.sum ./
RUN go mod download

# ì†ŒìŠ¤ ë³µì‚¬ ë° ë¹Œë“œ
COPY . .
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -ldflags="-w -s -X main.version=${VERSION}" \
    -o /app/bin/api ./cmd/api

# ============ Runtime Stage ============
FROM alpine:3.19

# ë³´ì•ˆ: non-root ì‚¬ìš©ì
RUN addgroup -g 1001 -S kerp && \
    adduser -u 1001 -S kerp -G kerp

# í•„ìˆ˜ íŒ¨í‚¤ì§€
RUN apk --no-cache add ca-certificates tzdata

WORKDIR /app

# ë°”ì´ë„ˆë¦¬ ë³µì‚¬
COPY --from=builder /app/bin/api /app/api
COPY --from=builder /app/configs /app/configs

# ê¶Œí•œ ì„¤ì •
RUN chown -R kerp:kerp /app
USER kerp

# í—¬ìŠ¤ì²´í¬
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget -qO- http://localhost:8080/health || exit 1

EXPOSE 8080

ENTRYPOINT ["/app/api"]
```

### 2.2 í”„ë¡ íŠ¸ì—”ë“œ Dockerfile

```dockerfile
# web/Dockerfile
# ============ Build Stage ============
FROM node:20-alpine AS builder

WORKDIR /app

# ì˜ì¡´ì„± ì„¤ì¹˜
COPY package*.json ./
RUN npm ci --only=production=false

# ë¹Œë“œ
COPY . .
ARG VITE_API_BASE_URL
ENV VITE_API_BASE_URL=$VITE_API_BASE_URL
RUN npm run build

# ============ Runtime Stage ============
FROM nginx:alpine

# Nginx ì„¤ì •
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

# í—¬ìŠ¤ì²´í¬
HEALTHCHECK --interval=30s --timeout=3s --retries=3 \
    CMD wget -qO- http://localhost:80/health || exit 1

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

---

## 3. Kubernetes ë°°í¬

### 3.1 API ì„œë²„ Deployment

```yaml
# deployments/k8s/production/api-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kerp-api
  namespace: kerp-prod
  labels:
    app: kerp
    component: api
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: kerp
      component: api
  template:
    metadata:
      labels:
        app: kerp
        component: api
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: kerp-api
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        fsGroup: 1001

      containers:
        - name: api
          image: kerp/api:${VERSION}
          imagePullPolicy: Always

          ports:
            - name: http
              containerPort: 8080
              protocol: TCP

          env:
            - name: ENV
              value: "production"
            - name: LOG_LEVEL
              value: "info"
            - name: LOG_FORMAT
              value: "json"

          envFrom:
            - configMapRef:
                name: kerp-config
            - secretRef:
                name: kerp-secrets

          resources:
            requests:
              cpu: "500m"
              memory: "512Mi"
            limits:
              cpu: "2000m"
              memory: "2Gi"

          livenessProbe:
            httpGet:
              path: /health/live
              port: http
            initialDelaySeconds: 15
            periodSeconds: 20
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3

          volumeMounts:
            - name: tmp
              mountPath: /tmp

      volumes:
        - name: tmp
          emptyDir: {}

      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: kerp
                    component: api
                topologyKey: kubernetes.io/hostname

      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: kerp
              component: api
```

### 3.2 HPA (Horizontal Pod Autoscaler)

```yaml
# deployments/k8s/production/api-hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: kerp-api-hpa
  namespace: kerp-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: kerp-api
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Pods
          value: 2
          periodSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60
```

### 3.3 Service & Ingress

```yaml
# deployments/k8s/production/api-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: kerp-api
  namespace: kerp-prod
  labels:
    app: kerp
    component: api
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP
  selector:
    app: kerp
    component: api
---
# deployments/k8s/production/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: kerp-ingress
  namespace: kerp-prod
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:...
    alb.ingress.kubernetes.io/ssl-policy: ELBSecurityPolicy-TLS-1-2-2017-01
    alb.ingress.kubernetes.io/healthcheck-path: /health
spec:
  rules:
    - host: api.kerp.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: kerp-api
                port:
                  number: 80
  tls:
    - hosts:
        - api.kerp.example.com
```

### 3.4 ConfigMap & Secrets

```yaml
# deployments/k8s/production/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: kerp-config
  namespace: kerp-prod
data:
  APP_NAME: "kerp-api"
  APP_ENV: "production"

  # Database
  DB_HOST: "kerp-db.cluster-xxx.ap-northeast-2.rds.amazonaws.com"
  DB_PORT: "5432"
  DB_NAME: "kerp"
  DB_SSLMODE: "require"
  DB_MAX_OPEN_CONNS: "100"
  DB_MAX_IDLE_CONNS: "10"

  # Redis
  REDIS_HOST: "kerp-redis.xxx.cache.amazonaws.com"
  REDIS_PORT: "6379"

  # NATS
  NATS_URL: "nats://kerp-nats:4222"

  # External Services
  POPBILL_ENV: "production"

  # Monitoring
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
---
# deployments/k8s/production/secrets.yaml (ì‹¤ì œë¡œëŠ” External Secrets ì‚¬ìš©)
apiVersion: v1
kind: Secret
metadata:
  name: kerp-secrets
  namespace: kerp-prod
type: Opaque
stringData:
  DB_PASSWORD: "${DB_PASSWORD}"
  REDIS_PASSWORD: "${REDIS_PASSWORD}"
  JWT_SECRET: "${JWT_SECRET}"
  POPBILL_LINK_ID: "${POPBILL_LINK_ID}"
  POPBILL_SECRET_KEY: "${POPBILL_SECRET_KEY}"
```

---

## 4. ë°°í¬ íŒŒì´í”„ë¼ì¸

### 4.1 GitHub Actions ë°°í¬ ì›Œí¬í”Œë¡œìš°

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches:
      - main
      - 'release/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com
  EKS_CLUSTER: kerp-cluster

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Generate version
        id: version
        run: |
          VERSION="${GITHUB_SHA::8}-$(date +%Y%m%d%H%M%S)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push API image
        run: |
          docker build -t $ECR_REGISTRY/kerp-api:${{ steps.version.outputs.version }} \
            --build-arg VERSION=${{ steps.version.outputs.version }} \
            -f backend/Dockerfile \
            ./backend
          docker push $ECR_REGISTRY/kerp-api:${{ steps.version.outputs.version }}

      - name: Build and push Web image
        run: |
          docker build -t $ECR_REGISTRY/kerp-web:${{ steps.version.outputs.version }} \
            --build-arg VITE_API_BASE_URL=${{ vars.API_BASE_URL }} \
            -f web/Dockerfile \
            ./web
          docker push $ECR_REGISTRY/kerp-web:${{ steps.version.outputs.version }}

  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')
    environment: staging

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name $EKS_CLUSTER --region $AWS_REGION

      - name: Deploy to staging
        run: |
          kubectl set image deployment/kerp-api \
            api=$ECR_REGISTRY/kerp-api:${{ needs.build.outputs.version }} \
            -n kerp-staging

          kubectl rollout status deployment/kerp-api -n kerp-staging --timeout=300s

  deploy-production:
    needs: [build, deploy-staging]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name $EKS_CLUSTER --region $AWS_REGION

      - name: Deploy to production
        run: |
          # Blue-Green ë°°í¬
          kubectl apply -f deployments/k8s/production/

          kubectl set image deployment/kerp-api \
            api=$ECR_REGISTRY/kerp-api:${{ needs.build.outputs.version }} \
            -n kerp-prod

          kubectl rollout status deployment/kerp-api -n kerp-prod --timeout=600s

      - name: Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Production deployment ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*K-ERP Production Deployment*\nVersion: `${{ needs.build.outputs.version }}`\nStatus: ${{ job.status }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
```

---

## 5. ìš´ì˜ ì ˆì°¨

### 5.1 ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

```markdown
## ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì½”ë“œ ê²€ì¦
- [ ] ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ
- [ ] ë³´ì•ˆ ìŠ¤ìº” í†µê³¼
- [ ] ë¦°í„° ê²€ì‚¬ í†µê³¼

### ë³€ê²½ ì‚¬í•­ í™•ì¸
- [ ] DB ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš” ì—¬ë¶€
- [ ] í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€/ë³€ê²½ ì—¬ë¶€
- [ ] ì™¸ë¶€ API ë³€ê²½ ì—¬ë¶€
- [ ] Breaking changes ì—¬ë¶€

### ë°°í¬ ì¤€ë¹„
- [ ] ë°°í¬ ê³µì§€ ì™„ë£Œ
- [ ] ë¡¤ë°± ê³„íš ìˆ˜ë¦½
- [ ] ëª¨ë‹ˆí„°ë§ ì•Œë¦¼ í™•ì¸

## ë°°í¬ í›„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ê²€ì¦
- [ ] í—¬ìŠ¤ì²´í¬ ì •ìƒ
- [ ] í•µì‹¬ ê¸°ëŠ¥ ë™ì‘ í™•ì¸
- [ ] ì—ëŸ¬ ë¡œê·¸ í™•ì¸
- [ ] ì„±ëŠ¥ ì§€í‘œ í™•ì¸

### ì™„ë£Œ
- [ ] ë°°í¬ ì™„ë£Œ ê³µì§€
- [ ] ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì‘ì„±
```

### 5.2 ë¡¤ë°± ì ˆì°¨

```bash
#!/bin/bash
# scripts/rollback.sh

set -e

NAMESPACE="${1:-kerp-prod}"
DEPLOYMENT="${2:-kerp-api}"
REVISION="${3}"

echo "=== K-ERP ë¡¤ë°± ì‹œì‘ ==="

# í˜„ì¬ ìƒíƒœ í™•ì¸
echo "í˜„ì¬ ë°°í¬ ìƒíƒœ:"
kubectl rollout history deployment/$DEPLOYMENT -n $NAMESPACE

# ë¡¤ë°± ì‹¤í–‰
if [ -z "$REVISION" ]; then
    echo "ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±..."
    kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE
else
    echo "ë¦¬ë¹„ì „ $REVISIONìœ¼ë¡œ ë¡¤ë°±..."
    kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE --to-revision=$REVISION
fi

# ë¡¤ë°± ìƒíƒœ í™•ì¸
kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE --timeout=300s

echo "=== ë¡¤ë°± ì™„ë£Œ ==="

# í˜„ì¬ ë²„ì „ í™•ì¸
kubectl get deployment $DEPLOYMENT -n $NAMESPACE -o jsonpath='{.spec.template.spec.containers[0].image}'
```

### 5.3 DB ë§ˆì´ê·¸ë ˆì´ì…˜

```bash
#!/bin/bash
# scripts/migrate.sh

set -e

ENV="${1:-production}"
ACTION="${2:-up}"

echo "=== DB ë§ˆì´ê·¸ë ˆì´ì…˜ ($ENV) ==="

# í™˜ê²½ë³„ ì„¤ì • ë¡œë“œ
case $ENV in
  production)
    DB_HOST="kerp-db.cluster-xxx.ap-northeast-2.rds.amazonaws.com"
    ;;
  staging)
    DB_HOST="kerp-db-staging.cluster-xxx.ap-northeast-2.rds.amazonaws.com"
    ;;
  *)
    echo "Unknown environment: $ENV"
    exit 1
    ;;
esac

# DB ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸° (AWS Secrets Manager)
DB_PASSWORD=$(aws secretsmanager get-secret-value \
    --secret-id kerp/$ENV/db-password \
    --query SecretString --output text)

DATABASE_URL="postgres://kerp:${DB_PASSWORD}@${DB_HOST}:5432/kerp?sslmode=require"

# ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
migrate -path db/migrations -database "$DATABASE_URL" $ACTION

echo "=== ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ==="
```

---

## 6. ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼

### 6.1 ì£¼ìš” ëª¨ë‹ˆí„°ë§ ì§€í‘œ

| ì§€í‘œ | ì„ê³„ê°’ | ì•Œë¦¼ ë ˆë²¨ |
|------|--------|----------|
| API ì‘ë‹µ ì‹œê°„ (p95) | > 500ms | Warning |
| API ì‘ë‹µ ì‹œê°„ (p95) | > 1000ms | Critical |
| ì—ëŸ¬ìœ¨ | > 1% | Warning |
| ì—ëŸ¬ìœ¨ | > 5% | Critical |
| CPU ì‚¬ìš©ë¥  | > 80% | Warning |
| ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  | > 85% | Warning |
| Pod ì¬ì‹œì‘ | > 3íšŒ/10ë¶„ | Critical |
| DB ì—°ê²° í’€ | > 80% | Warning |

### 6.2 ì•Œë¦¼ ì„¤ì •

```yaml
# monitoring/alertmanager-config.yaml
global:
  slack_api_url: "${SLACK_WEBHOOK_URL}"

route:
  receiver: 'slack-notifications'
  group_by: ['alertname', 'severity']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h

  routes:
    - match:
        severity: critical
      receiver: 'slack-critical'
      continue: true
    - match:
        severity: warning
      receiver: 'slack-warnings'

receivers:
  - name: 'slack-critical'
    slack_configs:
      - channel: '#kerp-alerts-critical'
        title: 'ğŸš¨ Critical Alert'
        text: '{{ .CommonAnnotations.description }}'
        send_resolved: true

  - name: 'slack-warnings'
    slack_configs:
      - channel: '#kerp-alerts'
        title: 'âš ï¸ Warning'
        text: '{{ .CommonAnnotations.description }}'
        send_resolved: true
```

---

## 7. ì¥ì•  ëŒ€ì‘

### 7.1 ì¥ì•  ë“±ê¸‰ ì •ì˜

| ë“±ê¸‰ | ì„¤ëª… | ëŒ€ì‘ ì‹œê°„ | ì˜ˆì‹œ |
|------|------|----------|------|
| P1 (Critical) | ì„œë¹„ìŠ¤ ì „ì²´ ì¥ì•  | 15ë¶„ | ì„œë²„ ë‹¤ìš´, DB ì¥ì•  |
| P2 (High) | ì£¼ìš” ê¸°ëŠ¥ ì¥ì•  | 30ë¶„ | ê²°ì œ ì‹¤íŒ¨, ë¡œê·¸ì¸ ë¶ˆê°€ |
| P3 (Medium) | ë¶€ë¶„ ê¸°ëŠ¥ ì¥ì•  | 2ì‹œê°„ | ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨ |
| P4 (Low) | ê²½ë¯¸í•œ ì´ìŠˆ | 24ì‹œê°„ | UI ë²„ê·¸ |

### 7.2 ì¥ì•  ëŒ€ì‘ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì¥ì•  ê°ì§€   â”‚â”€â”€â”€â”€â–¶â”‚  ë“±ê¸‰ íŒì •   â”‚â”€â”€â”€â”€â–¶â”‚  ë‹´ë‹¹ì í˜¸ì¶œ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì‚¬í›„ ë¶„ì„   â”‚â—€â”€â”€â”€â”€â”‚  ì„œë¹„ìŠ¤ ë³µêµ¬ â”‚â—€â”€â”€â”€â”€â”‚  ì›ì¸ ë¶„ì„   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì¬ë°œ ë°©ì§€   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 ì¥ì•  ëŒ€ì‘ ëª…ë ¹ì–´

```bash
# ê¸´ê¸‰ ìŠ¤ì¼€ì¼ ì•„ì›ƒ
kubectl scale deployment kerp-api --replicas=10 -n kerp-prod

# Pod ì¬ì‹œì‘
kubectl rollout restart deployment/kerp-api -n kerp-prod

# íŠ¹ì • Pod ì‚­ì œ (ì¬ìƒì„±)
kubectl delete pod kerp-api-xxx -n kerp-prod

# ë¡œê·¸ ì‹¤ì‹œê°„ í™•ì¸
kubectl logs -f deployment/kerp-api -n kerp-prod --tail=100

# ë¦¬ì†ŒìŠ¤ ìƒíƒœ í™•ì¸
kubectl top pods -n kerp-prod

# DB ì—°ê²° í™•ì¸
kubectl exec -it deployment/kerp-api -n kerp-prod -- \
  wget -qO- http://localhost:8080/health/ready
```

---

## 8. ìš´ì˜ ìë™í™”

### 8.1 ì •ê¸° ì‘ì—… (CronJob)

```yaml
# deployments/k8s/cronjobs.yaml

# ì¼ì¼ ë°±ì—…
apiVersion: batch/v1
kind: CronJob
metadata:
  name: daily-backup
  namespace: kerp-prod
spec:
  schedule: "0 2 * * *"  # ë§¤ì¼ 02:00 (KST 11:00)
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: backup
              image: kerp/backup:latest
              env:
                - name: BACKUP_TYPE
                  value: "daily"
          restartPolicy: OnFailure
---
# ì›”ë§ ë§ˆê° ë°°ì¹˜
apiVersion: batch/v1
kind: CronJob
metadata:
  name: month-end-closing
  namespace: kerp-prod
spec:
  schedule: "0 23 L * *"  # ë§¤ì›” ë§ˆì§€ë§‰ ë‚  23:00
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: closing
              image: kerp/worker:latest
              args: ["month-end-closing"]
          restartPolicy: OnFailure
---
# ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬
apiVersion: batch/v1
kind: CronJob
metadata:
  name: log-cleanup
  namespace: kerp-prod
spec:
  schedule: "0 4 * * 0"  # ë§¤ì£¼ ì¼ìš”ì¼ 04:00
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: cleanup
              image: kerp/maintenance:latest
              args: ["cleanup-logs", "--days=90"]
          restartPolicy: OnFailure
```

---

**ë¬¸ì„œ ë²„ì „**: 1.0
**ì‘ì„±ì¼**: 2025ë…„ 1ì›”
**ì‘ì„±ì**: K-ERP ê°œë°œíŒ€
