# K-ERP v0.2 - 배포 설정

**문서 버전**: 0.2.0
**작성일**: 2026-01-16
**상태**: 검토 대기

---

## 목차

1. [Docker 설정](#1-docker-설정)
2. [Kubernetes 설정](#2-kubernetes-설정)
3. [환경별 구성](#3-환경별-구성)

---

## 1. Docker 설정

### 1.1 Go API Server Dockerfile

```dockerfile
# deployments/docker/api-server/Dockerfile
FROM golang:1.22-alpine AS builder

WORKDIR /app

# 의존성 캐시
COPY go.mod go.sum ./
RUN go mod download

# 소스 복사 및 빌드
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o /bin/api ./cmd/api

# 실행 이미지
FROM alpine:3.19

RUN apk --no-cache add ca-certificates tzdata
ENV TZ=Asia/Seoul

COPY --from=builder /bin/api /bin/api

EXPOSE 8080

CMD ["/bin/api"]
```

### 1.2 Python Tax Scraper Dockerfile

```dockerfile
# python-services/tax-scraper/Dockerfile
FROM python:3.11-slim

WORKDIR /app

# 시스템 패키지
RUN apt-get update && apt-get install -y \
    chromium \
    chromium-driver \
    fonts-nanum \
    && rm -rf /var/lib/apt/lists/*

# Python 의존성
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Playwright 브라우저
RUN playwright install chromium

# 소스 복사
COPY shared/ /app/shared/
COPY tax-scraper/src/ /app/src/

ENV PYTHONPATH=/app
ENV PLAYWRIGHT_BROWSERS_PATH=/root/.cache/ms-playwright

EXPOSE 50051

CMD ["python", "-m", "src.main"]
```

### 1.3 Python Insurance EDI Dockerfile

```dockerfile
# python-services/insurance-edi/Dockerfile
FROM python:3.11-slim

WORKDIR /app

RUN apt-get update && apt-get install -y \
    fonts-nanum \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY shared/ /app/shared/
COPY insurance-edi/src/ /app/src/

ENV PYTHONPATH=/app

EXPOSE 50052

CMD ["python", "-m", "src.main"]
```

### 1.4 Docker Compose (개발환경)

```yaml
# docker-compose.yml
version: '3.8'

services:
  # 데이터베이스
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: kerp
      POSTGRES_USER: kerp
      POSTGRES_PASSWORD: kerp_dev_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  nats:
    image: nats:2.10-alpine
    ports:
      - "4222:4222"
      - "8222:8222"
    command: ["--jetstream", "-m", "8222"]

  # API 서버
  api-server:
    build:
      context: .
      dockerfile: deployments/docker/api-server/Dockerfile
    ports:
      - "8080:8080"
    environment:
      DATABASE_URL: postgres://kerp:kerp_dev_password@postgres:5432/kerp?sslmode=disable
      REDIS_URL: redis://redis:6379
      NATS_URL: nats://nats:4222
      TAX_SCRAPER_ADDR: tax-scraper:50051
      INSURANCE_EDI_ADDR: insurance-edi:50052
    depends_on:
      - postgres
      - redis
      - nats
      - tax-scraper
      - insurance-edi

  # Python 서비스
  tax-scraper:
    build:
      context: ./python-services
      dockerfile: tax-scraper/Dockerfile
    ports:
      - "50051:50051"
    environment:
      GRPC_PORT: 50051
      LOG_LEVEL: DEBUG

  insurance-edi:
    build:
      context: ./python-services
      dockerfile: insurance-edi/Dockerfile
    ports:
      - "50052:50052"
    environment:
      GRPC_PORT: 50052
      LOG_LEVEL: DEBUG

volumes:
  postgres_data:
```

---

## 2. Kubernetes 설정

### 2.1 Namespace 및 ConfigMap

```yaml
# deployments/k8s/base/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: kerp
  labels:
    app.kubernetes.io/name: kerp
---
# deployments/k8s/base/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: kerp-config
  namespace: kerp
data:
  LOG_LEVEL: "info"
  LOG_FORMAT: "json"
  TZ: "Asia/Seoul"
```

### 2.2 Go API Server Deployment

```yaml
# deployments/k8s/api-server/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-server
  namespace: kerp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api-server
  template:
    metadata:
      labels:
        app: api-server
    spec:
      containers:
      - name: api-server
        image: kerp/api-server:latest
        ports:
        - containerPort: 8080
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: kerp-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: kerp-secrets
              key: redis-url
        - name: TAX_SCRAPER_ADDR
          value: "tax-scraper:50051"
        - name: INSURANCE_EDI_ADDR
          value: "insurance-edi:50052"
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: api-server
  namespace: kerp
spec:
  selector:
    app: api-server
  ports:
  - port: 8080
    targetPort: 8080
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: api-server-hpa
  namespace: kerp
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: api-server
  minReplicas: 3
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

### 2.3 Python Services Deployment

```yaml
# deployments/k8s/tax-scraper/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tax-scraper
  namespace: kerp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: tax-scraper
  template:
    metadata:
      labels:
        app: tax-scraper
    spec:
      containers:
      - name: tax-scraper
        image: kerp/tax-scraper:latest
        ports:
        - containerPort: 50051
        env:
        - name: GRPC_PORT
          value: "50051"
        - name: LOG_LEVEL
          value: "INFO"
        resources:
          requests:
            cpu: "200m"
            memory: "512Mi"
          limits:
            cpu: "1000m"
            memory: "2Gi"
        livenessProbe:
          grpc:
            port: 50051
          initialDelaySeconds: 30
---
apiVersion: v1
kind: Service
metadata:
  name: tax-scraper
  namespace: kerp
spec:
  selector:
    app: tax-scraper
  ports:
  - port: 50051
    targetPort: 50051
---
# deployments/k8s/insurance-edi/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: insurance-edi
  namespace: kerp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: insurance-edi
  template:
    metadata:
      labels:
        app: insurance-edi
    spec:
      containers:
      - name: insurance-edi
        image: kerp/insurance-edi:latest
        ports:
        - containerPort: 50052
        env:
        - name: GRPC_PORT
          value: "50052"
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "1Gi"
---
apiVersion: v1
kind: Service
metadata:
  name: insurance-edi
  namespace: kerp
spec:
  selector:
    app: insurance-edi
  ports:
  - port: 50052
    targetPort: 50052
```

### 2.4 Ingress 설정

```yaml
# deployments/k8s/ingress/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: kerp-ingress
  namespace: kerp
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - api.kerp.io
    secretName: kerp-tls
  rules:
  - host: api.kerp.io
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-server
            port:
              number: 8080
```

---

## 3. 환경별 구성

### 3.1 환경 구분

| 환경 | 용도 | 리소스 |
|------|------|--------|
| dev | 개발 | 최소 |
| staging | 테스트 | 중간 |
| prod | 운영 | 최대 |

### 3.2 Kustomize 오버레이

```yaml
# deployments/k8s/overlays/dev/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: kerp-dev

resources:
- ../../base

patches:
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 1
  target:
    kind: Deployment

configMapGenerator:
- name: kerp-config
  behavior: merge
  literals:
  - LOG_LEVEL=debug
```

```yaml
# deployments/k8s/overlays/prod/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: kerp

resources:
- ../../base

patches:
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: "500m"
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: "2000m"
  target:
    kind: Deployment
    name: api-server
```

---

**다음 문서**: [07_구현_일정.md](./07_구현_일정.md)
