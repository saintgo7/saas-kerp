# 전자세금계산서 연동 설계서

## 1. 개요

### 1.1 전자세금계산서 제도
전자세금계산서는 사업자 간 재화 또는 용역을 공급할 때 부가가치세법에 따라 발행하는 전자 문서입니다.

### 1.2 법적 요구사항
- **발행 의무**: 법인사업자 및 직전연도 공급가액 1억원 이상 개인사업자
- **전송 기한**: 발급일의 다음 날까지 국세청 전송
- **보관 기간**: 5년간 전자 보관 의무

### 1.3 관련 문서
- **`28_세금계산서_스크래핑_설계.md`**: Provider 추상화 및 스크래핑 구현 상세

---

## 2. 국세청 연동 방식 분석

### 2.1 연동 방식 비교

```
┌─────────────────────────────────────────────────────────────────┐
│                    전자세금계산서 연동 방식                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  방식 1: ASP API 연동          방식 2: 직접 ASP 등록             │
│  ┌─────────────────────┐      ┌─────────────────────┐           │
│  │  우리 시스템        │      │  우리 시스템        │           │
│  │  (SaaS ERP)        │      │  (SaaS ERP)        │           │
│  └──────────┬──────────┘      └──────────┬──────────┘           │
│             │                            │                       │
│             ▼                            │                       │
│  ┌─────────────────────┐                │                       │
│  │  ASP 사업자         │                │                       │
│  │  (Popbill 등)       │                │                       │
│  └──────────┬──────────┘                │                       │
│             │                            │                       │
│             ▼                            ▼                       │
│  ┌─────────────────────────────────────────────────────┐        │
│  │                    국세청 e세로                      │        │
│  └─────────────────────────────────────────────────────┘        │
│                                                                  │
│  ✅ 권장: 개발 1-2주          ❌ 비권장: 인증 6개월+             │
│     비용: 건당 50-100원          비용: 초기 수천만원              │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 ASP 사업자 현황 (2024년 기준)

| 구분 | 등록 업체 수 | 설명 |
|------|-------------|------|
| **ASP 사업자** | 약 140개 | API 제공 사업자 |
| **ERP 사업자** | 약 163개 | 자체 ERP 연동 사업자 |
| **대용량 연계사업자** | 약 20개 | 삼성, LG 등 대기업 |

### 2.3 주요 ASP 서비스 비교

| 서비스 | 발행 단가 | 월 기본료 | SDK 지원 | 특징 |
|--------|----------|----------|----------|------|
| **Popbill** | 100원/건 | 없음 | PHP, Java, Go, Python, Node.js | 가장 많은 SDK |
| **Barobill** | 50-100원/건 | 없음 | PHP, Java, Python | 금융권 연동 강점 |
| **Smartbill** | 80원/건 | 없음 | REST API | 간편한 API |
| **CODEF** | API별 상이 | 없음 | REST API | 금융 데이터 특화 |

### 2.4 국내 주요 ERP 업체 연동 방식

```
┌─────────────────────────────────────────────────────────────────┐
│                  국내 ERP 업체 세금계산서 연동                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  더존비즈온                    이카운트                          │
│  ┌─────────────────────┐      ┌─────────────────────┐           │
│  │ Smart A / WEHAGO    │      │    이카운트 ERP     │           │
│  └──────────┬──────────┘      └──────────┬──────────┘           │
│             │                            │                       │
│             ▼                            ▼                       │
│  ┌─────────────────────┐      ┌─────────────────────┐           │
│  │   Bill36524         │      │   자체 ASP 시스템   │           │
│  │   (자회사 ASP)      │      │   (ASP 사업자 등록) │           │
│  └─────────────────────┘      └─────────────────────┘           │
│                                                                  │
│  영림원소프트랩                SAP/Oracle Korea                  │
│  ┌─────────────────────┐      ┌─────────────────────┐           │
│  │  시스템에버 ERP     │      │  SAP ERP / Oracle   │           │
│  └──────────┬──────────┘      └──────────┬──────────┘           │
│             │                            │                       │
│             ▼                            ▼                       │
│  ┌─────────────────────┐      ┌─────────────────────┐           │
│  │     트러스빌        │      │  Bill36524/트러스빌 │           │
│  │   (금융결제원)      │      │   (로컬라이징 ASP)  │           │
│  └─────────────────────┘      └─────────────────────┘           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 연동 전략: Provider 추상화 (무료 최대화)

> **상세 구현**: `28_세금계산서_스크래핑_설계.md` 참조

### 3.1 Provider 우선순위

```
+-----------------------------------------------------------------------+
|                      무료 최대화 Provider 전략                          |
+-----------------------------------------------------------------------+
|                                                                        |
|  우선순위 1: 홈택스 스크래핑 (Scraper)                                  |
|  +------------------------------------------------------------------+  |
|  | - 비용: 무료                                                      |  |
|  | - 조건: 공인인증서 유효 + 홈택스 정상 접속                         |  |
|  | - 목표: 90%+ 사용률                                               |  |
|  | - 구현: 28_세금계산서_스크래핑_설계.md 참조                        |  |
|  +------------------------------------------------------------------+  |
|                               |                                        |
|                          실패 시 Fallback                              |
|                               v                                        |
|  우선순위 2: 홈택스 Open API (NTS API)                                 |
|  +------------------------------------------------------------------+  |
|  | - 비용: 무료                                                      |  |
|  | - 조건: API 키 발급 + 일일 할당량 내                               |  |
|  | - 목표: 5% 사용률                                                 |  |
|  | - 상태: 2024년 일부 공개, 확대 예정                               |  |
|  +------------------------------------------------------------------+  |
|                               |                                        |
|                          실패 시 Fallback                              |
|                               v                                        |
|  우선순위 3: Popbill ASP (최후의 보루)                                 |
|  +------------------------------------------------------------------+  |
|  | - 비용: 100원/건                                                  |  |
|  | - 조건: 무료 Provider 모두 실패 시                                |  |
|  | - 목표: 5% 미만 사용률                                            |  |
|  | - 용도: 긴급 Fallback 전용                                        |  |
|  +------------------------------------------------------------------+  |
|                                                                        |
|  목표: Popbill 사용률 5% 미만 유지 (연간 수천만원 절감)                 |
|                                                                        |
+-----------------------------------------------------------------------+
```

### 3.2 Provider 선택 기준

| 우선순위 | Provider | 비용 | 안정성 | 사용 조건 | 목표 사용률 |
|----------|----------|------|--------|----------|------------|
| 1 | **Scraper** | 무료 | 중 | 인증서 유효 & 홈택스 정상 | 90%+ |
| 2 | **NTS API** | 무료 | 상 | API 키 발급 & 할당량 내 | 5% |
| 3 | **Popbill** | 100원/건 | 상 | 무료 Provider 실패 시 | 5% 미만 |

### 3.3 비용 절감 효과

| 월 발행량 | 100% Popbill | 무료 최대화 (95:5) | 절감액 | 연간 절감 |
|----------|-------------|-------------------|--------|----------|
| 1,000건 | 100,000원 | 5,000원 | 95,000원 | 1,140,000원 |
| 5,000건 | 500,000원 | 25,000원 | 475,000원 | 5,700,000원 |
| 10,000건 | 1,000,000원 | 50,000원 | 950,000원 | 11,400,000원 |

### 3.4 Popbill 연동 범위 (3순위 Fallback용)

| 기능 | API | 설명 |
|------|-----|------|
| **발행** | RegistIssue | 즉시 발행 (작성 + 발행) |
| **역발행** | RegistRequest | 역발행 요청 |
| **취소** | CancelIssue | 발행 취소 |
| **조회** | GetInfo / GetDetailInfo | 상태/상세 조회 |
| **목록** | Search | 목록 조회 |
| **미리보기** | GetPopUpURL | 팝업 미리보기 |
| **이메일 전송** | SendEmail | 거래처 이메일 전송 |
| **국세청 전송** | SendToNTS | 즉시 국세청 전송 |

### 3.4 Popbill 사용 시나리오

Popbill은 다음 상황에서 자동 활성화됩니다:

1. **인증서 미등록**: 회사에 공인인증서가 등록되지 않은 경우
2. **인증서 만료**: 등록된 인증서가 만료된 경우
3. **홈택스 장애**: 홈택스 접속 불가 또는 응답 지연
4. **스크래핑 실패**: 파싱 오류 등 스크래핑 실패 시

---

## 4. 데이터베이스 설계

### 4.1 ERD

```
┌─────────────────────────────────────────────────────────────────┐
│                    세금계산서 ERD                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────┐       ┌──────────────────┐                │
│  │    companies     │       │   tax_invoices   │                │
│  ├──────────────────┤       ├──────────────────┤                │
│  │ id               │◄──────│ company_id       │                │
│  │ business_number  │       │ id               │                │
│  │ name             │       │ invoice_number   │                │
│  │ ceo_name         │       │ issue_type       │                │
│  │ address          │       │ tax_type         │                │
│  │ business_type    │       │ supplier_*       │                │
│  │ business_item    │       │ buyer_*          │                │
│  └──────────────────┘       │ supply_amount    │                │
│                             │ tax_amount       │                │
│  ┌──────────────────┐       │ total_amount     │                │
│  │   trading_       │       │ issue_date       │                │
│  │   partners       │       │ nts_send_date    │                │
│  ├──────────────────┤       │ status           │                │
│  │ id               │       │ popbill_mgt_key  │                │
│  │ business_number  │◄──┐   └────────┬─────────┘                │
│  │ name             │   │            │                          │
│  │ ceo_name         │   │            │ 1:N                      │
│  │ email            │   │            │                          │
│  └──────────────────┘   │   ┌────────▼─────────┐                │
│                         │   │ tax_invoice_     │                │
│                         │   │ items            │                │
│                         │   ├──────────────────┤                │
│                         │   │ id               │                │
│                         └───│ tax_invoice_id   │                │
│                             │ item_date        │                │
│                             │ item_name        │                │
│                             │ specification    │                │
│                             │ quantity         │                │
│                             │ unit_price       │                │
│                             │ supply_amount    │                │
│                             │ tax_amount       │                │
│                             └──────────────────┘                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 테이블 상세 정의

#### tax_invoices (세금계산서)

| 컬럼 | 타입 | 설명 | 필수 |
|------|------|------|------|
| id | BIGINT | PK | Y |
| company_id | BIGINT | 회사 FK | Y |
| invoice_number | VARCHAR(24) | 국세청 승인번호 | N |
| issue_id | VARCHAR(24) | 문서관리번호 | Y |
| issue_type | ENUM | 정발행/역발행/위수탁 | Y |
| tax_type | ENUM | 과세/영세/면세 | Y |
| purpose_type | ENUM | 영수/청구 | Y |
| supplier_business_number | VARCHAR(10) | 공급자 사업자번호 | Y |
| supplier_name | VARCHAR(100) | 공급자 상호 | Y |
| supplier_ceo_name | VARCHAR(30) | 공급자 대표자 | Y |
| supplier_address | VARCHAR(300) | 공급자 주소 | N |
| supplier_business_type | VARCHAR(100) | 공급자 업태 | N |
| supplier_business_item | VARCHAR(100) | 공급자 종목 | N |
| supplier_email | VARCHAR(100) | 공급자 이메일 | N |
| buyer_business_number | VARCHAR(10) | 공급받는자 사업자번호 | Y |
| buyer_name | VARCHAR(100) | 공급받는자 상호 | Y |
| buyer_ceo_name | VARCHAR(30) | 공급받는자 대표자 | N |
| buyer_address | VARCHAR(300) | 공급받는자 주소 | N |
| buyer_email | VARCHAR(100) | 공급받는자 이메일 | N |
| supply_amount | BIGINT | 공급가액 (원) | Y |
| tax_amount | BIGINT | 세액 (원) | Y |
| total_amount | BIGINT | 합계금액 (원) | Y |
| issue_date | DATE | 작성일자 | Y |
| nts_send_date | TIMESTAMP | 국세청 전송일시 | N |
| nts_result_code | VARCHAR(10) | 국세청 처리코드 | N |
| nts_result_message | VARCHAR(200) | 국세청 처리메시지 | N |
| popbill_mgt_key | VARCHAR(24) | Popbill 관리번호 | Y |
| popbill_nts_key | VARCHAR(32) | 국세청 승인번호 | N |
| status | ENUM | 상태 | Y |
| remark | TEXT | 비고 | N |
| created_by | BIGINT | 작성자 | N |
| updated_by | BIGINT | 수정자 | N |
| created_at | TIMESTAMP | 생성일시 | Y |
| updated_at | TIMESTAMP | 수정일시 | Y |

**status ENUM 값**:
- `draft`: 작성중
- `issued`: 발행완료
- `sent`: 국세청전송
- `accepted`: 승인
- `rejected`: 거부
- `cancelled`: 취소

#### tax_invoice_items (세금계산서 품목)

| 컬럼 | 타입 | 설명 | 필수 |
|------|------|------|------|
| id | BIGINT | PK | Y |
| tax_invoice_id | BIGINT | 세금계산서 FK | Y |
| serial_number | INT | 순번 (1-99) | Y |
| item_date | DATE | 거래일자 | N |
| item_name | VARCHAR(100) | 품목명 | Y |
| specification | VARCHAR(100) | 규격 | N |
| quantity | DECIMAL(18,2) | 수량 | N |
| unit_price | DECIMAL(18,2) | 단가 | N |
| supply_amount | BIGINT | 공급가액 | Y |
| tax_amount | BIGINT | 세액 | Y |
| remark | VARCHAR(100) | 비고 | N |
| created_at | TIMESTAMP | 생성일시 | Y |
| updated_at | TIMESTAMP | 수정일시 | Y |

---

## 5. API 설계

### 5.1 내부 REST API

#### 세금계산서 목록 조회
```
GET /api/v1/tax-invoices
```
**Query Parameters**:
- `status`: 상태 필터
- `issue_date_from`: 작성일 시작
- `issue_date_to`: 작성일 종료
- `buyer_business_number`: 거래처 사업자번호
- `page`, `per_page`: 페이지네이션

#### 세금계산서 상세 조회
```
GET /api/v1/tax-invoices/{id}
```

#### 세금계산서 발행
```
POST /api/v1/tax-invoices
```
**Request Body**:
```json
{
  "issue_type": "정발행",
  "tax_type": "과세",
  "purpose_type": "영수",
  "buyer": {
    "business_number": "1234567890",
    "name": "거래처상호",
    "ceo_name": "대표자명",
    "email": "buyer@example.com"
  },
  "issue_date": "2025-01-15",
  "items": [
    {
      "item_name": "상품명",
      "quantity": 10,
      "unit_price": 10000,
      "supply_amount": 100000,
      "tax_amount": 10000
    }
  ],
  "remark": "비고"
}
```

#### 세금계산서 취소
```
POST /api/v1/tax-invoices/{id}/cancel
```

#### 세금계산서 국세청 즉시 전송
```
POST /api/v1/tax-invoices/{id}/send-to-nts
```

### 5.2 Provider 기반 발행 흐름

```
+-------------------------------------------------------------------+
|                  세금계산서 발행 프로세스 (Provider 추상화)          |
+-------------------------------------------------------------------+
|                                                                    |
|  1. 사용자 입력                                                    |
|     |                                                              |
|     v                                                              |
|  +-------------------------------------------------------------+  |
|  | POST /api/v1/tax-invoices                                   |  |
|  | - 공급자/공급받는자 정보                                     |  |
|  | - 품목 정보                                                  |  |
|  | - 금액 정보                                                  |  |
|  +-----------------------------+-------------------------------+  |
|                                |                                   |
|  2. 유효성 검사                v                                   |
|     |              +-----------------+                             |
|     |              | 사업자번호 검증  |                             |
|     |              | 금액 계산 검증   |                             |
|     |              | 필수값 체크      |                             |
|     |              +--------+--------+                             |
|     |                       |                                      |
|  3. DB 저장                 v                                      |
|     |              +-----------------+                             |
|     |              | tax_invoices    |                             |
|     |              | status: draft   |                             |
|     |              +--------+--------+                             |
|     |                       |                                      |
|  4. Provider 선택           v                                      |
|     |              +-----------------+                             |
|     |              | 인증서 확인     |                             |
|     |              +--------+--------+                             |
|     |                       |                                      |
|     |          +------------+------------+                         |
|     |          |                         |                         |
|     |     인증서 유효               인증서 없음/만료                |
|     |          |                         |                         |
|     |          v                         v                         |
|  5. Provider 발행                                                  |
|     |   +-------------+           +-------------+                  |
|     |   |  Scraper    |           |  Popbill    |                  |
|     |   | (홈택스)    |           |  (ASP)      |                  |
|     |   +------+------+           +------+------+                  |
|     |          |                         |                         |
|     |     실패 시 -----> Fallback -------+                         |
|     |          |                         |                         |
|     |          +-----------+-------------+                         |
|     |                      |                                       |
|  6. 결과 처리              v                                       |
|     |              +-----------------+                             |
|     |              | 성공: issued    |                             |
|     |              | provider_type   |                             |
|     |              | 기록            |                             |
|     |              +--------+--------+                             |
|     |                       |                                      |
|  7. 자동 NTS 전송          v                                       |
|                    +-----------------+                             |
|                    | 다음날 자정     |                             |
|                    | 자동 전송       |                             |
|                    | status: sent    |                             |
|                    +-----------------+                             |
|                                                                    |
+-------------------------------------------------------------------+
```

---

## 6. 구현 예시 코드 (Go)

### 6.1 세금계산서 서비스 (Provider 추상화)

```go
// internal/service/tax/service.go

package tax

import (
    "context"
    "crypto/rand"
    "encoding/hex"
    "fmt"
    "time"

    "github.com/google/uuid"
    "k-erp/internal/domain/tax"
    provider "k-erp/internal/infrastructure/tax"
    "k-erp/internal/repository"
)

type TaxInvoiceService struct {
    repo            repository.TaxInvoiceRepository
    certRepo        repository.CertRepository
    companyRepo     repository.CompanyRepository
    providerFactory *provider.ProviderFactory
}

func NewTaxInvoiceService(
    repo repository.TaxInvoiceRepository,
    certRepo repository.CertRepository,
    companyRepo repository.CompanyRepository,
    factory *provider.ProviderFactory,
) *TaxInvoiceService {
    return &TaxInvoiceService{
        repo:            repo,
        certRepo:        certRepo,
        companyRepo:     companyRepo,
        providerFactory: factory,
    }
}

// getProvider 회사 상태에 따른 Provider 선택
func (s *TaxInvoiceService) getProvider(ctx context.Context) (provider.TaxInvoiceProvider, error) {
    companyID := ctx.Value("company_id").(uuid.UUID)

    // 인증서 확인
    cert, err := s.certRepo.FindActiveByCompany(ctx, companyID)
    if err != nil || time.Now().After(cert.ExpiresAt) {
        // 인증서 없거나 만료 -> Popbill 사용
        return s.providerFactory.Create(provider.ProviderPopbill)
    }

    // 스크래퍼 사용
    return s.providerFactory.Create(provider.ProviderScraper)
}

// Issue 세금계산서 발행
func (s *TaxInvoiceService) Issue(ctx context.Context, input *IssueInput) (*tax.Invoice, error) {
    // 1. 관리번호 생성 (최대 24자리)
    mgtKey := s.generateMgtKey()

    // 2. 공급자(로그인 회사) 정보 조회
    companyID := ctx.Value("company_id").(uuid.UUID)
    supplier, err := s.companyRepo.FindByID(ctx, companyID)
    if err != nil {
        return nil, fmt.Errorf("failed to get company: %w", err)
    }

    // 3. 세금계산서 도메인 생성
    invoice := &tax.Invoice{
        CompanyID:        companyID,
        MgtKey:           mgtKey,
        IssueType:        input.IssueType,
        InvoiceType:      input.InvoiceType,
        SupplierCorpNum:  supplier.BusinessNumber,
        SupplierCorpName: supplier.Name,
        SupplierCEOName:  supplier.CEOName,
        BuyerCorpNum:     input.BuyerCorpNum,
        BuyerCorpName:    input.BuyerCorpName,
        BuyerCEOName:     input.BuyerCEOName,
        SupplyValue:      input.SupplyValue,
        TaxAmount:        input.TaxAmount,
        TotalAmount:      input.SupplyValue + input.TaxAmount,
        Status:           tax.StatusDraft,
    }

    // 4. DB 저장 (draft)
    if err := s.repo.Create(ctx, invoice); err != nil {
        return nil, fmt.Errorf("failed to save invoice: %w", err)
    }

    // 5. Provider 선택 및 발행
    prov, err := s.getProvider(ctx)
    if err != nil {
        return nil, fmt.Errorf("failed to get provider: %w", err)
    }

    result, err := prov.Issue(ctx, invoice)
    if err != nil {
        // Scraper 실패 시 Popbill Fallback
        if prov.ProviderType() == provider.ProviderScraper {
            popbillProv, _ := s.providerFactory.Create(provider.ProviderPopbill)
            result, err = popbillProv.Issue(ctx, invoice)
            if err != nil {
                invoice.ProviderError = err.Error()
                _ = s.repo.Update(ctx, invoice)
                return nil, fmt.Errorf("issue failed: %w", err)
            }
            invoice.ProviderType = string(provider.ProviderPopbill)
        } else {
            invoice.ProviderError = err.Error()
            _ = s.repo.Update(ctx, invoice)
            return nil, fmt.Errorf("issue failed: %w", err)
        }
    } else {
        invoice.ProviderType = string(prov.ProviderType())
    }

    // 6. 발행 성공 - 상태 업데이트
    invoice.Status = tax.StatusIssued
    invoice.NTSConfirmNum = result.NTSConfirmNum
    if err := s.repo.Update(ctx, invoice); err != nil {
        return nil, fmt.Errorf("failed to update invoice: %w", err)
    }

    return invoice, nil
}

// generateMgtKey 관리번호 생성 (최대 24자리: YYYYMMDDHHmmss + 10자리 랜덤)
func (s *TaxInvoiceService) generateMgtKey() string {
    timestamp := time.Now().Format("20060102150405")
    random := make([]byte, 5)
    rand.Read(random)
    return timestamp + hex.EncodeToString(random)
}
```

### 6.2 Popbill 클라이언트 구현

```go
// internal/infrastructure/popbill/client.go

package popbill

import (
    "bytes"
    "context"
    "crypto/hmac"
    "crypto/sha256"
    "encoding/base64"
    "encoding/json"
    "fmt"
    "net/http"
    "time"

    "k-erp/internal/domain"
)

type Client struct {
    linkID    string
    secretKey string
    baseURL   string
    isTest    bool
    httpClient *http.Client
}

type Config struct {
    LinkID    string
    SecretKey string
    IsTest    bool
}

func NewClient(cfg *Config) *Client {
    baseURL := "https://popbill.linkhub.co.kr"
    if cfg.IsTest {
        baseURL = "https://popbill-test.linkhub.co.kr"
    }

    return &Client{
        linkID:    cfg.LinkID,
        secretKey: cfg.SecretKey,
        baseURL:   baseURL,
        isTest:    cfg.IsTest,
        httpClient: &http.Client{
            Timeout: 30 * time.Second,
        },
    }
}

// RegistIssue 세금계산서 즉시 발행
func (c *Client) RegistIssue(ctx context.Context, invoice *domain.TaxInvoice) (*IssueResult, error) {
    req := c.buildTaxInvoiceRequest(invoice)

    endpoint := fmt.Sprintf("/Taxinvoice/%s", invoice.SupplierBusinessNumber)
    body, err := c.doRequest(ctx, "POST", endpoint, req)
    if err != nil {
        return nil, err
    }

    var result IssueResult
    if err := json.Unmarshal(body, &result); err != nil {
        return nil, fmt.Errorf("응답 파싱 실패: %w", err)
    }

    return &result, nil
}

// CancelIssue 발행 취소
func (c *Client) CancelIssue(ctx context.Context, corpNum, mgtKeyType, mgtKey, reason string) error {
    endpoint := fmt.Sprintf("/Taxinvoice/%s/%s/%s", corpNum, mgtKeyType, mgtKey)
    req := map[string]string{"memo": reason}

    _, err := c.doRequest(ctx, "DELETE", endpoint, req)
    return err
}

// GetInfo 상태 조회
func (c *Client) GetInfo(ctx context.Context, corpNum, mgtKeyType, mgtKey string) (*StatusResult, error) {
    endpoint := fmt.Sprintf("/Taxinvoice/%s/%s/%s", corpNum, mgtKeyType, mgtKey)

    body, err := c.doRequest(ctx, "GET", endpoint, nil)
    if err != nil {
        return nil, err
    }

    var result StatusResult
    if err := json.Unmarshal(body, &result); err != nil {
        return nil, fmt.Errorf("응답 파싱 실패: %w", err)
    }

    return &result, nil
}

func (c *Client) buildTaxInvoiceRequest(invoice *domain.TaxInvoice) *TaxInvoiceRequest {
    req := &TaxInvoiceRequest{
        WriteDate:        invoice.IssueDate.Format("20060102"),
        ChargeDirection:  "정과금",
        IssueType:        convertIssueType(invoice.IssueType),
        TaxType:          convertTaxType(invoice.TaxType),
        PurposeType:      invoice.PurposeType,
        InvoicerCorpNum:  invoice.SupplierBusinessNumber,
        InvoicerCorpName: invoice.SupplierName,
        InvoicerCEOName:  invoice.SupplierCEOName,
        InvoicerAddr:     invoice.SupplierAddress,
        InvoicerMgtKey:   invoice.PopbillMgtKey,
        InvoiceeType:     "사업자",
        InvoiceeCorpNum:  invoice.BuyerBusinessNumber,
        InvoiceeCorpName: invoice.BuyerName,
        InvoiceeCEOName:  invoice.BuyerCEOName,
        InvoiceeAddr:     invoice.BuyerAddress,
        InvoiceeEmail1:   invoice.BuyerEmail,
        SupplyCostTotal:  fmt.Sprintf("%d", invoice.SupplyAmount),
        TaxTotal:         fmt.Sprintf("%d", invoice.TaxAmount),
        TotalAmount:      fmt.Sprintf("%d", invoice.TotalAmount),
    }

    // 품목 추가
    for _, item := range invoice.Items {
        req.DetailList = append(req.DetailList, TaxInvoiceDetail{
            SerialNum:  item.SerialNumber,
            ItemName:   item.ItemName,
            Qty:        item.Quantity,
            UnitCost:   item.UnitPrice,
            SupplyCost: fmt.Sprintf("%d", item.SupplyAmount),
            Tax:        fmt.Sprintf("%d", item.TaxAmount),
        })
    }

    return req
}

func (c *Client) doRequest(ctx context.Context, method, endpoint string, body interface{}) ([]byte, error) {
    var reqBody []byte
    var err error

    if body != nil {
        reqBody, err = json.Marshal(body)
        if err != nil {
            return nil, fmt.Errorf("요청 직렬화 실패: %w", err)
        }
    }

    req, err := http.NewRequestWithContext(ctx, method, c.baseURL+endpoint, bytes.NewReader(reqBody))
    if err != nil {
        return nil, fmt.Errorf("요청 생성 실패: %w", err)
    }

    // 인증 헤더 설정
    req.Header.Set("Content-Type", "application/json")
    req.Header.Set("x-lh-date", time.Now().UTC().Format(time.RFC3339))
    req.Header.Set("x-lh-version", "2.1")

    resp, err := c.httpClient.Do(req)
    if err != nil {
        return nil, fmt.Errorf("HTTP 요청 실패: %w", err)
    }
    defer resp.Body.Close()

    // 응답 읽기
    var respBody bytes.Buffer
    if _, err := respBody.ReadFrom(resp.Body); err != nil {
        return nil, fmt.Errorf("응답 읽기 실패: %w", err)
    }

    // 에러 응답 처리
    if resp.StatusCode >= 400 {
        var errResp ErrorResponse
        if err := json.Unmarshal(respBody.Bytes(), &errResp); err == nil {
            return nil, &PopbillError{Code: errResp.Code, Message: errResp.Message}
        }
        return nil, fmt.Errorf("HTTP %d: %s", resp.StatusCode, respBody.String())
    }

    return respBody.Bytes(), nil
}

func convertIssueType(t string) string {
    switch t {
    case "정발행":
        return "정발행"
    case "역발행":
        return "역발행"
    case "위수탁":
        return "위수탁"
    default:
        return "정발행"
    }
}

func convertTaxType(t string) string {
    switch t {
    case "과세":
        return "과세"
    case "영세":
        return "영세"
    case "면세":
        return "면세"
    default:
        return "과세"
    }
}
```

### 6.3 Popbill 타입 정의

```go
// internal/infrastructure/popbill/types.go

package popbill

// TaxInvoiceRequest 세금계산서 발행 요청
type TaxInvoiceRequest struct {
    WriteDate        string             `json:"writeDate"`
    ChargeDirection  string             `json:"chargeDirection"`
    IssueType        string             `json:"issueType"`
    TaxType          string             `json:"taxType"`
    PurposeType      string             `json:"purposeType"`
    InvoicerCorpNum  string             `json:"invoicerCorpNum"`
    InvoicerCorpName string             `json:"invoicerCorpName"`
    InvoicerCEOName  string             `json:"invoicerCEOName"`
    InvoicerAddr     string             `json:"invoicerAddr"`
    InvoicerMgtKey   string             `json:"invoicerMgtKey"`
    InvoiceeType     string             `json:"invoiceeType"`
    InvoiceeCorpNum  string             `json:"invoiceeCorpNum"`
    InvoiceeCorpName string             `json:"invoiceeCorpName"`
    InvoiceeCEOName  string             `json:"invoiceeCEOName"`
    InvoiceeAddr     string             `json:"invoiceeAddr"`
    InvoiceeEmail1   string             `json:"invoiceeEmail1"`
    SupplyCostTotal  string             `json:"supplyCostTotal"`
    TaxTotal         string             `json:"taxTotal"`
    TotalAmount      string             `json:"totalAmount"`
    DetailList       []TaxInvoiceDetail `json:"detailList"`
}

// TaxInvoiceDetail 세금계산서 품목
type TaxInvoiceDetail struct {
    SerialNum  int    `json:"serialNum"`
    ItemName   string `json:"itemName"`
    Qty        int    `json:"qty,omitempty"`
    UnitCost   int64  `json:"unitCost,omitempty"`
    SupplyCost string `json:"supplyCost"`
    Tax        string `json:"tax"`
}

// IssueResult 발행 결과
type IssueResult struct {
    Code          int    `json:"code"`
    Message       string `json:"message"`
    NTSConfirmNum string `json:"ntsConfirmNum"`
    InvoiceNum    string `json:"invoiceNum"`
}

// StatusResult 상태 조회 결과
type StatusResult struct {
    StateCode   int    `json:"stateCode"`
    StateDT     string `json:"stateDT"`
    NTSResult   string `json:"ntsresult"`
    NTSResultDT string `json:"ntsresultDT"`
}

// ErrorResponse Popbill 에러 응답
type ErrorResponse struct {
    Code    int    `json:"code"`
    Message string `json:"message"`
}

// PopbillError 커스텀 에러 타입
type PopbillError struct {
    Code    int
    Message string
}

func (e *PopbillError) Error() string {
    return fmt.Sprintf("popbill error [%d]: %s", e.Code, e.Message)
}
```

---

## 7. 에러 처리

### 7.1 Popbill 에러 코드

| 코드 | 설명 | 대응 방안 |
|------|------|----------|
| -11000008 | 사업자번호 미등록 | 연동회원 가입 필요 |
| -12000004 | 중복 관리번호 | 관리번호 재생성 |
| -14000018 | 인증서 만료 | 인증서 갱신 필요 |
| -20000013 | 잔여 포인트 부족 | 포인트 충전 필요 |
| -32000014 | 국세청 전송 실패 | 재전송 시도 |

### 7.2 에러 처리 전략

```go
// internal/service/taxinvoice/error_handler.go

package taxinvoice

import (
    "errors"
    "log/slog"

    "k-erp/internal/infrastructure/popbill"
)

func (s *TaxInvoiceService) handlePopbillError(err error) error {
    var popbillErr *popbill.PopbillError
    if !errors.As(err, &popbillErr) {
        return err
    }

    switch popbillErr.Code {
    case -20000013:
        // 잔여 포인트 부족 알림
        s.notifyLowBalance()
        return &domain.BusinessError{
            Code:    "LOW_BALANCE",
            Message: "Popbill 포인트가 부족합니다",
        }

    case -14000018:
        // 인증서 만료 알림
        s.notifyCertExpiry()
        return &domain.BusinessError{
            Code:    "CERT_EXPIRED",
            Message: "공동인증서가 만료되었습니다",
        }

    case -12000004:
        // 중복 관리번호 - 재생성 후 재시도
        return &domain.BusinessError{
            Code:    "DUPLICATE_MGT_KEY",
            Message: "중복된 관리번호입니다. 재시도하세요.",
        }

    default:
        slog.Error("Popbill error",
            "code", popbillErr.Code,
            "message", popbillErr.Message,
        )
        return &domain.BusinessError{
            Code:    "POPBILL_ERROR",
            Message: popbillErr.Message,
        }
    }
}
```

---

## 8. 테스트 전략

### 8.1 테스트 환경
- Popbill 테스트 계정 사용 (`IsTest = true`)
- 테스트 사업자번호: `1234567890`
- 테스트 환경에서는 국세청 실제 전송 없음

### 8.2 테스트 케이스

| 케이스 | 설명 | 예상 결과 |
|--------|------|----------|
| TC001 | 정상 발행 | status: issued |
| TC002 | 중복 관리번호 | 에러 -12000004 |
| TC003 | 발행 후 취소 | status: cancelled |
| TC004 | 역발행 요청 | status: issued (역발행) |
| TC005 | 잘못된 사업자번호 | 에러 -11000015 |

---

## 9. 참고 문서

| 문서 | 설명 |
|------|------|
| `28_세금계산서_스크래핑_설계.md` | 스크래핑 Provider 구현 상세 |
| `07_보안_설계.md` | 인증서 암호화 패턴 |
| `13_DB_스키마_상세.md` | tax_invoices 테이블 스키마 |

---

**문서 버전**: 3.0
**작성일**: 2025년 1월
**수정일**: 2025년 1월 (무료 최대화 전략 반영)
**작성자**: K-ERP 개발팀
**주요 변경사항**:
- Provider 우선순위 변경: Scraper(1) -> NTS API(2) -> Popbill(3)
- Popbill을 3순위 Fallback으로 변경 (목표: 5% 미만 사용)
- 비용 절감 효과 시뮬레이션 추가
- 상세 구현은 `28_세금계산서_스크래핑_설계.md` 참조
