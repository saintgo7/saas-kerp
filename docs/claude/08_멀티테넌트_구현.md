# K-ERP ë©€í‹°í…Œë„ŒíŠ¸ êµ¬í˜„ ì„¤ê³„ì„œ

## 1. ë©€í‹°í…Œë„ŒíŠ¸ ê°œìš”

### 1.1 ë©€í‹°í…Œë„ŒíŠ¸ ì „ëžµ ë¹„êµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ë©€í‹°í…Œë„ŒíŠ¸ ì•„í‚¤í…ì²˜ ì˜µì…˜                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ì˜µì…˜ 1: ë°ì´í„°ë² ì´ìŠ¤ ë¶„ë¦¬ (Database per Tenant)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ìž¥ì : ì™„ë²½í•œ ê²©ë¦¬, ë°±ì—…/ë³µêµ¬ ë…ë¦½                       â”‚    â”‚
â”‚  â”‚  ë‹¨ì : ì»¤ë„¥ì…˜ ê´€ë¦¬ ë³µìž¡, ë¹„ìš© ë†’ìŒ, ìŠ¤ì¼€ì¼ ì–´ë ¤ì›€        â”‚    â”‚
â”‚  â”‚  ì í•©: ëŒ€ê¸°ì—… ê³ ê°, ê·œì œ ìš”êµ¬ì‚¬í•­                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â”‚  ì˜µì…˜ 2: ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬ (Schema per Tenant)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ìž¥ì : ì¢‹ì€ ê²©ë¦¬, ë§ˆì´ê·¸ë ˆì´ì…˜ ìœ ì—°                      â”‚    â”‚
â”‚  â”‚  ë‹¨ì : ìŠ¤í‚¤ë§ˆ ìˆ˜ ì œí•œ, ë³µìž¡í•œ ì¿¼ë¦¬                       â”‚    â”‚
â”‚  â”‚  ì í•©: ì¤‘ê°„ ê·œëª¨ ê³ ê°                                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â”‚  âœ… ì˜µì…˜ 3: í–‰ ë¶„ë¦¬ (Row-Level Tenant) â† ì„ íƒ                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ìž¥ì : ë‹¨ìˆœí•œ êµ¬ì¡°, ë¹„ìš© íš¨ìœ¨, ì‰¬ìš´ ìŠ¤ì¼€ì¼               â”‚    â”‚
â”‚  â”‚  ë‹¨ì : RLS í•„ìˆ˜, ì¿¼ë¦¬ ì„±ëŠ¥ ê³ ë ¤ í•„ìš”                     â”‚    â”‚
â”‚  â”‚  ì í•©: SaaS, ì¤‘ì†Œê¸°ì—… ë‹¤ìˆ˜ ê³ ê°                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â”‚  ì„ íƒ ì´ìœ :                                                      â”‚
â”‚  â€¢ ì¤‘ì†Œê¸°ì—… ëŒ€ìƒ SaaS â†’ ê³ ê° ìˆ˜ ë§ŽìŒ, ë°ì´í„° ì ìŒ               â”‚
â”‚  â€¢ ë¹„ìš© íš¨ìœ¨ ì¤‘ìš”                                                â”‚
â”‚  â€¢ PostgreSQL RLSë¡œ ì•ˆì „í•˜ê²Œ ê²©ë¦¬ ê°€ëŠ¥                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 í…Œë„ŒíŠ¸ ê²©ë¦¬ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    í…Œë„ŒíŠ¸ ê²©ë¦¬ íë¦„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  HTTP Request (Bearer Token)                                    â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  1. Auth Middleware                                      â”‚    â”‚
â”‚  â”‚     - JWT ê²€ì¦                                           â”‚    â”‚
â”‚  â”‚     - company_id ì¶”ì¶œ                                    â”‚    â”‚
â”‚  â”‚     - ì»¨í…ìŠ¤íŠ¸ì— ì €ìž¥                                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  2. Tenant Middleware                                    â”‚    â”‚
â”‚  â”‚     - company_id ìœ íš¨ì„± ê²€ì¦                             â”‚    â”‚
â”‚  â”‚     - DB ì„¸ì…˜ì— tenant context ì„¤ì •                      â”‚    â”‚
â”‚  â”‚     - PostgreSQL SET app.current_tenant                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  3. Handler / Service                                    â”‚    â”‚
â”‚  â”‚     - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬                                 â”‚    â”‚
â”‚  â”‚     - company_id ìžë™ ì£¼ìž… (GORM Hook)                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  4. PostgreSQL + RLS                                     â”‚    â”‚
â”‚  â”‚     - Row Level Security ì •ì±… ì ìš©                       â”‚    â”‚
â”‚  â”‚     - company_id ìžë™ í•„í„°ë§                             â”‚    â”‚
â”‚  â”‚     - ë‹¤ë¥¸ í…Œë„ŒíŠ¸ ë°ì´í„° ì ‘ê·¼ ë¶ˆê°€                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ë©€í‹°í…Œë„Œì‹œ ê³„ì¸µë³„ ë°ì´í„° íë¦„

> âš ï¸ **ì¤‘ìš”**: K-ERPì˜ ë©€í‹°í…Œë„Œì‹œëŠ” **3ì¤‘ ê³„ì¸µ ë³´ì•ˆ**ìœ¼ë¡œ êµ¬í˜„ë©ë‹ˆë‹¤.
> ê° ê³„ì¸µì€ ë…ë¦½ì ìœ¼ë¡œ ë™ìž‘í•˜ë©°, í•˜ë‚˜ì˜ ê³„ì¸µì´ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ê³„ì¸µì´ ë³´í˜¸í•©ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    K-ERP ë©€í‹°í…Œë„Œì‹œ 3ì¤‘ ê³„ì¸µ ë³´ì•ˆ íë¦„                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ê³„ì¸µ 1: API Gateway / HTTP í—¤ë”                                      â”‚    â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  í´ë¼ì´ì–¸íŠ¸ ìš”ì²­                                                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚    â”‚
â”‚  â”‚  â”‚ GET /api/v1/vouchers                                   â”‚         â”‚    â”‚
â”‚  â”‚  â”‚ Authorization: Bearer eyJhbGc...                       â”‚         â”‚    â”‚
â”‚  â”‚  â”‚ X-Company-ID: 550e8400-e29b-41d4-a716-446655440001    â”‚         â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  ì—­í• : ìš”ì²­ì—ì„œ í…Œë„ŒíŠ¸ ì‹ë³„ìž ì¶”ì¶œ (JWT claim ë˜ëŠ” í—¤ë”)             â”‚    â”‚
â”‚  â”‚  ë³´ì•ˆ: JWT ì„œëª… ê²€ì¦, ë§Œë£Œ í™•ì¸, company_id claim ì¶”ì¶œ               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                  â”‚                                           â”‚
â”‚                                  â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ê³„ì¸µ 2: Go ë¯¸ë“¤ì›¨ì–´ + GORM í”ŒëŸ¬ê·¸ì¸                                  â”‚    â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  Auth Middleware                Tenant Middleware                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚  â”‚ 1. JWT íŒŒì‹±/ê²€ì¦   â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ 2. company_id ìœ íš¨ì„± ê²€ì¦  â”‚       â”‚    â”‚
â”‚  â”‚  â”‚ 2. Claims ì¶”ì¶œ     â”‚        â”‚ 3. íšŒì‚¬ í™œì„± ìƒíƒœ í™•ì¸     â”‚       â”‚    â”‚
â”‚  â”‚  â”‚ 3. ctxì— ì €ìž¥      â”‚        â”‚ 4. DB ì„¸ì…˜ ì„¤ì •:           â”‚       â”‚    â”‚
â”‚  â”‚  â”‚                    â”‚        â”‚    SET app.current_tenant  â”‚       â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â”‚                                               â”‚                      â”‚    â”‚
â”‚  â”‚                                               â–¼                      â”‚    â”‚
â”‚  â”‚                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚                                â”‚ GORM Tenant Plugin         â”‚       â”‚    â”‚
â”‚  â”‚                                â”‚ â€¢ SELECT: WHERE ì¡°ê±´ ì¶”ê°€  â”‚       â”‚    â”‚
â”‚  â”‚                                â”‚ â€¢ INSERT: company_id ìžë™  â”‚       â”‚    â”‚
â”‚  â”‚                                â”‚ â€¢ UPDATE/DELETE: ë²”ìœ„ ì œí•œ â”‚       â”‚    â”‚
â”‚  â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â”‚                                               â”‚                      â”‚    â”‚
â”‚  â”‚  ì—­í• : ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ í…Œë„ŒíŠ¸ ê²©ë¦¬ ì ìš©                            â”‚    â”‚
â”‚  â”‚  ë³´ì•ˆ: ìš”ì²­ ë°”ë””ì˜ company_id ë¬´ì‹œ, JWT claimë§Œ ì‹ ë¢°                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                  â”‚                                           â”‚
â”‚                                  â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ê³„ì¸µ 3: PostgreSQL Row Level Security (RLS)                          â”‚    â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  ëª¨ë“  SQL ì¿¼ë¦¬ì— ìžë™ ì ìš© (DB ë ˆë²¨ ê°•ì œ)                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚    â”‚
â”‚  â”‚  â”‚                                                         â”‚         â”‚    â”‚
â”‚  â”‚  â”‚  ì›ë³¸ ì¿¼ë¦¬:                                             â”‚         â”‚    â”‚
â”‚  â”‚  â”‚  SELECT * FROM vouchers WHERE status = 'APPROVED'       â”‚         â”‚    â”‚
â”‚  â”‚  â”‚                                                         â”‚         â”‚    â”‚
â”‚  â”‚  â”‚                      â–¼ RLS ì •ì±… ì ìš©                     â”‚         â”‚    â”‚
â”‚  â”‚  â”‚                                                         â”‚         â”‚    â”‚
â”‚  â”‚  â”‚  ì‹¤ì œ ì‹¤í–‰:                                             â”‚         â”‚    â”‚
â”‚  â”‚  â”‚  SELECT * FROM vouchers                                 â”‚         â”‚    â”‚
â”‚  â”‚  â”‚  WHERE status = 'APPROVED'                              â”‚         â”‚    â”‚
â”‚  â”‚  â”‚    AND company_id = current_tenant_id()  â† RLS ìžë™ì¶”ê°€ â”‚         â”‚    â”‚
â”‚  â”‚  â”‚                                                         â”‚         â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  current_tenant_id() í•¨ìˆ˜:                                           â”‚    â”‚
â”‚  â”‚  â†’ SET app.current_tenant ê°’ ë°˜í™˜ (ê³„ì¸µ 2ì—ì„œ ì„¤ì •)                  â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  ì—­í• : ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ ìµœì¢… ë°©ì–´ì„  (ìš°íšŒ ë¶ˆê°€)                      â”‚    â”‚
â”‚  â”‚  ë³´ì•ˆ: ì• í”Œë¦¬ì¼€ì´ì…˜ ë²„ê·¸/ì·¨ì•½ì  ìžˆì–´ë„ íƒ€ í…Œë„ŒíŠ¸ ë°ì´í„° ì ‘ê·¼ ë¶ˆê°€    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 ê³„ì¸µê°„ ë°ì´í„° ì „ë‹¬ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         í…Œë„ŒíŠ¸ ID ì „ë‹¬ ì‹œí€€ìŠ¤                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  Client                API                  Middleware               DB       â”‚
â”‚    â”‚                    â”‚                      â”‚                      â”‚       â”‚
â”‚    â”‚  HTTP Request      â”‚                      â”‚                      â”‚       â”‚
â”‚    â”‚  + JWT Token       â”‚                      â”‚                      â”‚       â”‚
â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                      â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚  1. JWT ê²€ì¦         â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚  company_id ì¶”ì¶œ     â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚  2. íšŒì‚¬ ìƒíƒœ í™•ì¸   â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚  3. SET app.current_ â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚     tenant = 'uuid'  â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚  ctxì— tenant_id     â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚  4. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§    â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚     GORM ì¿¼ë¦¬ ì‹¤í–‰   â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚      â”‚
â”‚    â”‚                    â”‚                      â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚  5. RLS ì •ì±… ì ìš©    â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚  company_id í•„í„°     â”‚       â”‚
â”‚    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚                      â”‚       â”‚
â”‚    â”‚  JSON Response     â”‚                      â”‚                      â”‚       â”‚
â”‚    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                      â”‚       â”‚
â”‚    â”‚                    â”‚                      â”‚                      â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.5 ì™œ 3ì¤‘ ê³„ì¸µì¸ê°€?

| ê³„ì¸µ | ë‹¨ë… ì‚¬ìš© ì‹œ ì·¨ì•½ì  | ë‹¤ì¤‘ ê³„ì¸µì—ì„œ ì—­í•  |
|------|---------------------|-------------------|
| **API í—¤ë”** | ìœ„ë³€ì¡° ê°€ëŠ¥ | ìš”ì²­ ì‹ë³„, ë¼ìš°íŒ… |
| **ë¯¸ë“¤ì›¨ì–´** | ì• í”Œë¦¬ì¼€ì´ì…˜ ë²„ê·¸ë¡œ ìš°íšŒ ê°€ëŠ¥ | ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì ìš©, ê²€ì¦ |
| **RLS** | ì„±ëŠ¥ ì˜¤ë²„í—¤ë“œ | **ìµœì¢… ë°©ì–´ì„ ** (ìš°íšŒ ë¶ˆê°€) |

> ðŸ’¡ **í•µì‹¬ ì›ì¹™**: í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚´ëŠ” `company_id`ëŠ” **ì ˆëŒ€ ì‹ ë¢°í•˜ì§€ ì•ŠìŒ**.
> ì˜¤ì§ JWT í† í°ì—ì„œ ì¶”ì¶œí•œ `company_id`ë§Œ ì‚¬ìš©í•˜ë©°, RLSê°€ DB ë ˆë²¨ì—ì„œ ê°•ì œ.

---

## 2. PostgreSQL Row Level Security (RLS)

### 2.1 RLS ê¸°ë³¸ ì„¤ì •

```sql
-- db/migrations/000001_enable_rls.up.sql

-- 1. í…Œë„ŒíŠ¸ ì»¨í…ìŠ¤íŠ¸ ì„¤ì • í•¨ìˆ˜
CREATE OR REPLACE FUNCTION current_tenant_id()
RETURNS UUID AS $$
BEGIN
    RETURN NULLIF(current_setting('app.current_tenant', TRUE), '')::UUID;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 2. RLS í™œì„±í™” ë° ì •ì±… ìƒì„± í•¨ìˆ˜
CREATE OR REPLACE FUNCTION enable_rls_for_table(table_name TEXT)
RETURNS VOID AS $$
BEGIN
    -- RLS í™œì„±í™”
    EXECUTE format('ALTER TABLE %I ENABLE ROW LEVEL SECURITY', table_name);

    -- ê¸°ë³¸ ì •ì±…: SELECT
    EXECUTE format('
        CREATE POLICY %I_tenant_select ON %I
        FOR SELECT
        USING (company_id = current_tenant_id())
    ', table_name, table_name);

    -- ê¸°ë³¸ ì •ì±…: INSERT
    EXECUTE format('
        CREATE POLICY %I_tenant_insert ON %I
        FOR INSERT
        WITH CHECK (company_id = current_tenant_id())
    ', table_name, table_name);

    -- ê¸°ë³¸ ì •ì±…: UPDATE
    EXECUTE format('
        CREATE POLICY %I_tenant_update ON %I
        FOR UPDATE
        USING (company_id = current_tenant_id())
        WITH CHECK (company_id = current_tenant_id())
    ', table_name, table_name);

    -- ê¸°ë³¸ ì •ì±…: DELETE
    EXECUTE format('
        CREATE POLICY %I_tenant_delete ON %I
        FOR DELETE
        USING (company_id = current_tenant_id())
    ', table_name, table_name);
END;
$$ LANGUAGE plpgsql;

-- 3. ìˆ˜í¼ìœ ì €ìš© ë°”ì´íŒ¨ìŠ¤ ì—­í• 
CREATE ROLE kerp_admin NOLOGIN;
ALTER ROLE kerp_admin SET row_security TO off;

-- 4. ì• í”Œë¦¬ì¼€ì´ì…˜ ì—­í•  (RLS ì ìš©)
CREATE ROLE kerp_app NOLOGIN;
GRANT kerp_app TO kerp;  -- ì‹¤ì œ ë¡œê·¸ì¸ ì‚¬ìš©ìž
```

### 2.2 í…Œì´ë¸”ë³„ RLS ì ìš©

```sql
-- db/migrations/000002_create_tables_with_rls.up.sql

-- íšŒì‚¬ í…Œì´ë¸” (í…Œë„ŒíŠ¸ ìžì²´)
CREATE TABLE companies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    business_number VARCHAR(10) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    ceo_name VARCHAR(50) NOT NULL,
    address VARCHAR(500),
    phone VARCHAR(20),
    email VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì‚¬ìš©ìž í…Œì´ë¸”
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id),
    email VARCHAR(100) NOT NULL,
    password_hash VARCHAR(200) NOT NULL,
    name VARCHAR(50) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(company_id, email)
);

CREATE INDEX idx_users_company_id ON users(company_id);
SELECT enable_rls_for_table('users');

-- ê³„ì •ê³¼ëª© í…Œì´ë¸”
CREATE TABLE accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id),
    code VARCHAR(10) NOT NULL,
    name VARCHAR(100) NOT NULL,
    account_type VARCHAR(20) NOT NULL,
    parent_id UUID REFERENCES accounts(id),
    level INT DEFAULT 1,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(company_id, code)
);

CREATE INDEX idx_accounts_company_id ON accounts(company_id);
CREATE INDEX idx_accounts_code ON accounts(company_id, code);
SELECT enable_rls_for_table('accounts');

-- ì „í‘œ í…Œì´ë¸”
CREATE TABLE vouchers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id),
    voucher_number VARCHAR(20) NOT NULL,
    voucher_date DATE NOT NULL,
    description VARCHAR(500),
    status VARCHAR(20) DEFAULT 'DRAFT',
    total_debit BIGINT DEFAULT 0,
    total_credit BIGINT DEFAULT 0,
    created_by UUID NOT NULL REFERENCES users(id),
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(company_id, voucher_number)
);

CREATE INDEX idx_vouchers_company_id ON vouchers(company_id);
CREATE INDEX idx_vouchers_date ON vouchers(company_id, voucher_date);
SELECT enable_rls_for_table('vouchers');

-- ì „í‘œ ìƒì„¸ í…Œì´ë¸”
CREATE TABLE voucher_lines (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id),
    voucher_id UUID NOT NULL REFERENCES vouchers(id) ON DELETE CASCADE,
    line_number INT NOT NULL,
    account_id UUID NOT NULL REFERENCES accounts(id),
    description VARCHAR(200),
    debit_amount BIGINT DEFAULT 0,
    credit_amount BIGINT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_voucher_lines_company_id ON voucher_lines(company_id);
CREATE INDEX idx_voucher_lines_voucher_id ON voucher_lines(voucher_id);
SELECT enable_rls_for_table('voucher_lines');

-- ì§ì› í…Œì´ë¸”
CREATE TABLE employees (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id),
    employee_number VARCHAR(20) NOT NULL,
    name VARCHAR(50) NOT NULL,
    resident_number VARCHAR(200),  -- ì•”í˜¸í™” ì €ìž¥
    email VARCHAR(100),
    phone VARCHAR(20),
    hire_date DATE NOT NULL,
    resign_date DATE,
    status VARCHAR(20) DEFAULT 'ACTIVE',
    base_salary BIGINT DEFAULT 0,
    bank_account VARCHAR(200),  -- ì•”í˜¸í™” ì €ìž¥
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(company_id, employee_number)
);

CREATE INDEX idx_employees_company_id ON employees(company_id);
SELECT enable_rls_for_table('employees');

-- ì„¸ê¸ˆê³„ì‚°ì„œ í…Œì´ë¸”
CREATE TABLE tax_invoices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id),
    invoice_number VARCHAR(24),
    issue_type VARCHAR(20) NOT NULL,
    tax_type VARCHAR(20) NOT NULL,
    supplier_business_number VARCHAR(10) NOT NULL,
    supplier_name VARCHAR(100) NOT NULL,
    buyer_business_number VARCHAR(10) NOT NULL,
    buyer_name VARCHAR(100) NOT NULL,
    supply_amount BIGINT NOT NULL,
    tax_amount BIGINT NOT NULL,
    total_amount BIGINT NOT NULL,
    issue_date DATE NOT NULL,
    status VARCHAR(20) DEFAULT 'DRAFT',
    popbill_mgt_key VARCHAR(24),
    nts_send_date TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_tax_invoices_company_id ON tax_invoices(company_id);
CREATE INDEX idx_tax_invoices_issue_date ON tax_invoices(company_id, issue_date);
SELECT enable_rls_for_table('tax_invoices');
```

### 2.3 RLS ë¡¤ë°± (down migration)

```sql
-- db/migrations/000002_create_tables_with_rls.down.sql

DROP TABLE IF EXISTS tax_invoices CASCADE;
DROP TABLE IF EXISTS employees CASCADE;
DROP TABLE IF EXISTS voucher_lines CASCADE;
DROP TABLE IF EXISTS vouchers CASCADE;
DROP TABLE IF EXISTS accounts CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP TABLE IF EXISTS companies CASCADE;

DROP FUNCTION IF EXISTS enable_rls_for_table(TEXT);
DROP FUNCTION IF EXISTS current_tenant_id();
DROP ROLE IF EXISTS kerp_admin;
DROP ROLE IF EXISTS kerp_app;
```

---

## 3. Go ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬í˜„

### 3.1 í…Œë„ŒíŠ¸ ë¯¸ë“¤ì›¨ì–´

```go
// internal/middleware/tenant.go

package middleware

import (
    "database/sql"
    "fmt"
    "github.com/gin-gonic/gin"
    "github.com/google/uuid"
)

type TenantMiddleware struct {
    db *sql.DB
}

func NewTenantMiddleware(db *sql.DB) *TenantMiddleware {
    return &TenantMiddleware{db: db}
}

func (t *TenantMiddleware) Handler() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 1. ì»¨í…ìŠ¤íŠ¸ì—ì„œ company_id ê°€ì ¸ì˜¤ê¸° (Auth ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì„¤ì •ë¨)
        companyIDStr, exists := c.Get("company_id")
        if !exists {
            c.AbortWithStatusJSON(401, gin.H{
                "success": false,
                "error": gin.H{
                    "code":    "UNAUTHORIZED",
                    "message": "Company context not found",
                },
            })
            return
        }

        companyID, err := uuid.Parse(companyIDStr.(string))
        if err != nil {
            c.AbortWithStatusJSON(400, gin.H{
                "success": false,
                "error": gin.H{
                    "code":    "INVALID_TENANT",
                    "message": "Invalid company ID format",
                },
            })
            return
        }

        // 2. íšŒì‚¬ ì¡´ìž¬ ì—¬ë¶€ ë° í™œì„± ìƒíƒœ í™•ì¸
        var isActive bool
        err = t.db.QueryRowContext(c.Request.Context(),
            "SELECT is_active FROM companies WHERE id = $1",
            companyID,
        ).Scan(&isActive)

        if err == sql.ErrNoRows {
            c.AbortWithStatusJSON(404, gin.H{
                "success": false,
                "error": gin.H{
                    "code":    "TENANT_NOT_FOUND",
                    "message": "Company not found",
                },
            })
            return
        }

        if !isActive {
            c.AbortWithStatusJSON(403, gin.H{
                "success": false,
                "error": gin.H{
                    "code":    "TENANT_INACTIVE",
                    "message": "Company account is inactive",
                },
            })
            return
        }

        // 3. PostgreSQL ì„¸ì…˜ì— í…Œë„ŒíŠ¸ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
        //    (RLS ì •ì±…ì—ì„œ current_tenant_id() í•¨ìˆ˜ê°€ ì´ ê°’ì„ ì½ìŒ)
        _, err = t.db.ExecContext(c.Request.Context(),
            fmt.Sprintf("SET app.current_tenant = '%s'", companyID.String()),
        )
        if err != nil {
            c.AbortWithStatusJSON(500, gin.H{
                "success": false,
                "error": gin.H{
                    "code":    "INTERNAL_ERROR",
                    "message": "Failed to set tenant context",
                },
            })
            return
        }

        // 4. UUID í˜•íƒœë¡œ ì»¨í…ìŠ¤íŠ¸ì— ì €ìž¥
        c.Set("company_uuid", companyID)

        c.Next()
    }
}
```

### 3.2 GORM í…Œë„ŒíŠ¸ ì»¨í…ìŠ¤íŠ¸ í”ŒëŸ¬ê·¸ì¸

```go
// internal/infrastructure/database/tenant_plugin.go

package database

import (
    "context"
    "fmt"
    "github.com/google/uuid"
    "gorm.io/gorm"
)

type TenantKey struct{}

// ì»¨í…ìŠ¤íŠ¸ì—ì„œ í…Œë„ŒíŠ¸ ID ê°€ì ¸ì˜¤ê¸°
func GetTenantID(ctx context.Context) (uuid.UUID, bool) {
    id, ok := ctx.Value(TenantKey{}).(uuid.UUID)
    return id, ok
}

// ì»¨í…ìŠ¤íŠ¸ì— í…Œë„ŒíŠ¸ ID ì„¤ì •
func WithTenantID(ctx context.Context, tenantID uuid.UUID) context.Context {
    return context.WithValue(ctx, TenantKey{}, tenantID)
}

// GORM í”ŒëŸ¬ê·¸ì¸: ëª¨ë“  ì¿¼ë¦¬ì— ìžë™ìœ¼ë¡œ company_id ì¡°ê±´ ì¶”ê°€
type TenantPlugin struct{}

func (p *TenantPlugin) Name() string {
    return "tenant_plugin"
}

func (p *TenantPlugin) Initialize(db *gorm.DB) error {
    // SELECT/UPDATE/DELETEì— WHERE company_id ì¡°ê±´ ìžë™ ì¶”ê°€
    db.Callback().Query().Before("gorm:query").Register("tenant:before_query", beforeQuery)
    db.Callback().Update().Before("gorm:update").Register("tenant:before_update", beforeQuery)
    db.Callback().Delete().Before("gorm:delete").Register("tenant:before_delete", beforeQuery)

    // INSERTì— company_id ìžë™ ì„¤ì •
    db.Callback().Create().Before("gorm:create").Register("tenant:before_create", beforeCreate)

    return nil
}

func beforeQuery(db *gorm.DB) {
    if db.Statement.Context == nil {
        return
    }

    tenantID, ok := GetTenantID(db.Statement.Context)
    if !ok {
        return
    }

    // í…Œë„ŒíŠ¸ ì»¬ëŸ¼ì´ ìžˆëŠ” í…Œì´ë¸”ì—ë§Œ ì ìš©
    if hasTenantColumn(db.Statement.Schema) {
        db.Statement.AddClause(clause.Where{
            Exprs: []clause.Expression{
                clause.Eq{
                    Column: clause.Column{Table: db.Statement.Table, Name: "company_id"},
                    Value:  tenantID,
                },
            },
        })
    }
}

func beforeCreate(db *gorm.DB) {
    if db.Statement.Context == nil {
        return
    }

    tenantID, ok := GetTenantID(db.Statement.Context)
    if !ok {
        return
    }

    // Reflectë¥¼ ì‚¬ìš©í•´ company_id í•„ë“œì— ê°’ ì„¤ì •
    if hasTenantColumn(db.Statement.Schema) {
        field := db.Statement.Schema.LookUpField("CompanyID")
        if field != nil {
            db.Statement.SetColumn("company_id", tenantID)
        }
    }
}

func hasTenantColumn(schema *schema.Schema) bool {
    if schema == nil {
        return false
    }
    _, ok := schema.FieldsByDBName["company_id"]
    return ok
}
```

### 3.3 ë² ì´ìŠ¤ ëª¨ë¸ (í…Œë„ŒíŠ¸ í•„ë“œ í¬í•¨)

```go
// internal/domain/base.go

package domain

import (
    "time"
    "github.com/google/uuid"
)

// TenantModel: ë©€í‹°í…Œë„ŒíŠ¸ í…Œì´ë¸”ì˜ ë² ì´ìŠ¤ ëª¨ë¸
type TenantModel struct {
    ID        uuid.UUID `gorm:"type:uuid;primary_key;default:gen_random_uuid()"`
    CompanyID uuid.UUID `gorm:"type:uuid;index;not null"`
    CreatedAt time.Time `gorm:"autoCreateTime"`
    UpdatedAt time.Time `gorm:"autoUpdateTime"`
}

// BeforeCreate: ìƒì„± ì „ ID ìžë™ ìƒì„±
func (m *TenantModel) BeforeCreate(tx *gorm.DB) error {
    if m.ID == uuid.Nil {
        m.ID = uuid.New()
    }
    return nil
}

// ì˜ˆì‹œ: Voucher ëª¨ë¸
type Voucher struct {
    TenantModel                      // ìž„ë² ë“œ
    VoucherNumber string             `gorm:"size:20;not null"`
    VoucherDate   time.Time          `gorm:"type:date;not null"`
    Description   string             `gorm:"size:500"`
    Status        VoucherStatus      `gorm:"size:20;default:'DRAFT'"`
    TotalDebit    int64              `gorm:"default:0"`
    TotalCredit   int64              `gorm:"default:0"`
    CreatedBy     uuid.UUID          `gorm:"type:uuid;not null"`
    ApprovedBy    *uuid.UUID         `gorm:"type:uuid"`
    ApprovedAt    *time.Time
    Lines         []VoucherLine      `gorm:"foreignKey:VoucherID"`
}
```

### 3.4 ë ˆí¬ì§€í† ë¦¬ íŒ¨í„´ (í…Œë„ŒíŠ¸ ì ìš©)

```go
// internal/repository/voucher_repo.go

package repository

import (
    "context"
    "k-erp/internal/domain"
    "k-erp/internal/infrastructure/database"
    "gorm.io/gorm"
)

type VoucherRepository interface {
    Create(ctx context.Context, voucher *domain.Voucher) error
    FindByID(ctx context.Context, id uuid.UUID) (*domain.Voucher, error)
    FindByNumber(ctx context.Context, number string) (*domain.Voucher, error)
    List(ctx context.Context, filter *VoucherFilter) ([]*domain.Voucher, int64, error)
    Update(ctx context.Context, voucher *domain.Voucher) error
    Delete(ctx context.Context, id uuid.UUID) error
}

type voucherRepository struct {
    db *gorm.DB
}

func NewVoucherRepository(db *gorm.DB) VoucherRepository {
    return &voucherRepository{db: db}
}

// Create: í…Œë„ŒíŠ¸ ì»¨í…ìŠ¤íŠ¸ê°€ ìžë™ìœ¼ë¡œ company_idë¥¼ ì„¤ì •
func (r *voucherRepository) Create(ctx context.Context, voucher *domain.Voucher) error {
    // GORM í”ŒëŸ¬ê·¸ì¸ì´ ctxì—ì„œ tenant IDë¥¼ ì½ì–´ ìžë™ ì„¤ì •
    return r.db.WithContext(ctx).Create(voucher).Error
}

// FindByID: RLSê°€ ìžë™ìœ¼ë¡œ í˜„ìž¬ í…Œë„ŒíŠ¸ ë°ì´í„°ë§Œ ë°˜í™˜
func (r *voucherRepository) FindByID(ctx context.Context, id uuid.UUID) (*domain.Voucher, error) {
    var voucher domain.Voucher

    // PostgreSQL RLS + GORM í”ŒëŸ¬ê·¸ì¸ì´ company_id ì¡°ê±´ ìžë™ ì¶”ê°€
    err := r.db.WithContext(ctx).
        Preload("Lines").
        First(&voucher, "id = ?", id).Error

    if err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return nil, nil
        }
        return nil, err
    }

    return &voucher, nil
}

// List: í•„í„°ë§ + íŽ˜ì´ì§€ë„¤ì´ì…˜
func (r *voucherRepository) List(ctx context.Context, filter *VoucherFilter) ([]*domain.Voucher, int64, error) {
    var vouchers []*domain.Voucher
    var total int64

    query := r.db.WithContext(ctx).Model(&domain.Voucher{})

    // ì¶”ê°€ í•„í„° (company_idëŠ” RLSê°€ ìžë™ ì ìš©)
    if filter.Status != "" {
        query = query.Where("status = ?", filter.Status)
    }
    if !filter.StartDate.IsZero() {
        query = query.Where("voucher_date >= ?", filter.StartDate)
    }
    if !filter.EndDate.IsZero() {
        query = query.Where("voucher_date <= ?", filter.EndDate)
    }

    // ì „ì²´ ì¹´ìš´íŠ¸
    if err := query.Count(&total).Error; err != nil {
        return nil, 0, err
    }

    // íŽ˜ì´ì§€ë„¤ì´ì…˜
    offset := (filter.Page - 1) * filter.PerPage
    err := query.
        Order("voucher_date DESC, created_at DESC").
        Offset(offset).
        Limit(filter.PerPage).
        Find(&vouchers).Error

    return vouchers, total, err
}
```

### 3.5 ì„œë¹„ìŠ¤ ë ˆì´ì–´ (í…Œë„ŒíŠ¸ ì»¨í…ìŠ¤íŠ¸ ì „ë‹¬)

```go
// internal/service/accounting/voucher_service.go

package accounting

import (
    "context"
    "fmt"
    "k-erp/internal/domain"
    "k-erp/internal/repository"
)

type VoucherService struct {
    repo   repository.VoucherRepository
    audit  *audit.AuditService
}

func NewVoucherService(
    repo repository.VoucherRepository,
    audit *audit.AuditService,
) *VoucherService {
    return &VoucherService{
        repo:  repo,
        audit: audit,
    }
}

// CreateVoucher: ctxì— í…Œë„ŒíŠ¸ ì •ë³´ê°€ í¬í•¨ë¨
func (s *VoucherService) CreateVoucher(ctx context.Context, input *CreateVoucherInput) (*domain.Voucher, error) {
    // 1. ì°¨ëŒ€ë³€ ê· í˜• ê²€ì¦
    var totalDebit, totalCredit int64
    for _, line := range input.Lines {
        totalDebit += line.DebitAmount
        totalCredit += line.CreditAmount
    }

    if totalDebit != totalCredit {
        return nil, &domain.BusinessError{
            Code:    "BALANCE_ERROR",
            Message: fmt.Sprintf("ì°¨ë³€(%d)ê³¼ ëŒ€ë³€(%d)ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤", totalDebit, totalCredit),
        }
    }

    // 2. ì „í‘œ ìƒì„± (company_idëŠ” ë ˆí¬ì§€í† ë¦¬ì—ì„œ ìžë™ ì„¤ì •)
    voucher := &domain.Voucher{
        VoucherNumber: input.VoucherNumber,
        VoucherDate:   input.VoucherDate,
        Description:   input.Description,
        Status:        domain.VoucherStatusDraft,
        TotalDebit:    totalDebit,
        TotalCredit:   totalCredit,
        CreatedBy:     input.UserID,
    }

    for i, lineInput := range input.Lines {
        voucher.Lines = append(voucher.Lines, domain.VoucherLine{
            LineNumber:   i + 1,
            AccountID:    lineInput.AccountID,
            Description:  lineInput.Description,
            DebitAmount:  lineInput.DebitAmount,
            CreditAmount: lineInput.CreditAmount,
        })
    }

    // 3. ì €ìž¥ (ctx ì „ë‹¬ â†’ í…Œë„ŒíŠ¸ ìžë™ ì ìš©)
    if err := s.repo.Create(ctx, voucher); err != nil {
        return nil, fmt.Errorf("ì „í‘œ ì €ìž¥ ì‹¤íŒ¨: %w", err)
    }

    // 4. ê°ì‚¬ ë¡œê·¸
    s.audit.Log(ctx, &audit.AuditEntry{
        Action:     domain.AuditActionCreate,
        Resource:   "voucher",
        ResourceID: voucher.ID.String(),
        NewValue:   voucher,
    })

    return voucher, nil
}
```

### 3.6 í•¸ë“¤ëŸ¬ (ì»¨í…ìŠ¤íŠ¸ ì²´ì¸)

```go
// internal/handler/voucher_handler.go

package handler

import (
    "github.com/gin-gonic/gin"
    "k-erp/internal/infrastructure/database"
    "k-erp/internal/service/accounting"
)

type VoucherHandler struct {
    service *accounting.VoucherService
}

func NewVoucherHandler(service *accounting.VoucherService) *VoucherHandler {
    return &VoucherHandler{service: service}
}

// Create: POST /api/v1/vouchers
func (h *VoucherHandler) Create(c *gin.Context) {
    // 1. ìš”ì²­ ë°”ë”” íŒŒì‹±
    var req CreateVoucherRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(400, gin.H{"success": false, "error": gin.H{"code": "VALIDATION_ERROR", "message": err.Error()}})
        return
    }

    // 2. ì»¨í…ìŠ¤íŠ¸ì—ì„œ í…Œë„ŒíŠ¸ ID, ì‚¬ìš©ìž ID ì¶”ì¶œ
    companyID := c.MustGet("company_uuid").(uuid.UUID)
    userID := c.MustGet("user_id").(string)

    // 3. í…Œë„ŒíŠ¸ ì»¨í…ìŠ¤íŠ¸ í¬í•¨ëœ context ìƒì„±
    ctx := database.WithTenantID(c.Request.Context(), companyID)

    // 4. ì„œë¹„ìŠ¤ í˜¸ì¶œ
    input := &accounting.CreateVoucherInput{
        VoucherNumber: req.VoucherNumber,
        VoucherDate:   req.VoucherDate,
        Description:   req.Description,
        Lines:         req.Lines,
        UserID:        uuid.MustParse(userID),
    }

    voucher, err := h.service.CreateVoucher(ctx, input)
    if err != nil {
        handleError(c, err)
        return
    }

    c.JSON(201, gin.H{
        "success": true,
        "data":    toVoucherResponse(voucher),
    })
}
```

---

## 4. í…Œë„ŒíŠ¸ ê²©ë¦¬ ê²€ì¦

### 4.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

```go
// internal/repository/voucher_repo_test.go

func TestVoucherRepository_TenantIsolation(t *testing.T) {
    db := setupTestDB(t)

    // ë‘ ê°œì˜ íšŒì‚¬ ìƒì„±
    company1 := &domain.Company{ID: uuid.New(), Name: "Company A"}
    company2 := &domain.Company{ID: uuid.New(), Name: "Company B"}
    db.Create(company1)
    db.Create(company2)

    repo := NewVoucherRepository(db)

    // Company 1ì˜ ì „í‘œ ìƒì„±
    ctx1 := database.WithTenantID(context.Background(), company1.ID)
    voucher1 := &domain.Voucher{VoucherNumber: "V-001", VoucherDate: time.Now()}
    err := repo.Create(ctx1, voucher1)
    require.NoError(t, err)

    // Company 2ì˜ ì „í‘œ ìƒì„±
    ctx2 := database.WithTenantID(context.Background(), company2.ID)
    voucher2 := &domain.Voucher{VoucherNumber: "V-001", VoucherDate: time.Now()}
    err = repo.Create(ctx2, voucher2)
    require.NoError(t, err)

    // Company 1 ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì¡°íšŒ â†’ ìžê¸° ë°ì´í„°ë§Œ ë³´ì—¬ì•¼ í•¨
    result1, _, err := repo.List(ctx1, &VoucherFilter{Page: 1, PerPage: 100})
    require.NoError(t, err)
    assert.Len(t, result1, 1)
    assert.Equal(t, voucher1.ID, result1[0].ID)

    // Company 2 ì»¨í…ìŠ¤íŠ¸ì—ì„œ Company 1 ì „í‘œ ì¡°íšŒ â†’ nil ë°˜í™˜
    found, err := repo.FindByID(ctx2, voucher1.ID)
    require.NoError(t, err)
    assert.Nil(t, found)  // ë‹¤ë¥¸ í…Œë„ŒíŠ¸ ë°ì´í„° ì ‘ê·¼ ë¶ˆê°€
}
```

### 4.2 í†µí•© í…ŒìŠ¤íŠ¸ (RLS ê²€ì¦)

```go
// internal/repository/rls_integration_test.go

func TestRLS_TenantIsolation(t *testing.T) {
    if testing.Short() {
        t.Skip("Skipping integration test")
    }

    db := setupPostgresTestDB(t)  // ì‹¤ì œ PostgreSQL ì»¨í…Œì´ë„ˆ

    // ë‘ íšŒì‚¬ ìƒì„±
    company1ID := uuid.New()
    company2ID := uuid.New()

    db.Exec("INSERT INTO companies (id, business_number, name, ceo_name) VALUES ($1, '1234567890', 'Aì‚¬', 'í™ê¸¸ë™')", company1ID)
    db.Exec("INSERT INTO companies (id, business_number, name, ceo_name) VALUES ($1, '0987654321', 'Bì‚¬', 'ê¹€ì² ìˆ˜')", company2ID)

    // Company 1 ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì „í‘œ ìƒì„±
    db.Exec(fmt.Sprintf("SET app.current_tenant = '%s'", company1ID))
    db.Exec("INSERT INTO vouchers (id, company_id, voucher_number, voucher_date, created_by) VALUES ($1, $2, 'V-001', NOW(), $3)",
        uuid.New(), company1ID, uuid.New())

    // Company 2 ì»¨í…ìŠ¤íŠ¸ë¡œ ì „í™˜
    db.Exec(fmt.Sprintf("SET app.current_tenant = '%s'", company2ID))

    // Company 1ì˜ ì „í‘œê°€ ë³´ì´ì§€ ì•Šì•„ì•¼ í•¨
    var count int
    db.QueryRow("SELECT COUNT(*) FROM vouchers").Scan(&count)
    assert.Equal(t, 0, count)
}
```

### 4.3 ë³´ì•ˆ ì¹¨íˆ¬ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   í…Œë„ŒíŠ¸ ê²©ë¦¬ ì¹¨íˆ¬ í…ŒìŠ¤íŠ¸                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ì‹œë‚˜ë¦¬ì˜¤ 1: URL íŒŒë¼ë¯¸í„° ë³€ì¡°                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ê³µê²©: GET /api/v1/vouchers/[ë‹¤ë¥¸íšŒì‚¬ì „í‘œID]                    â”‚
â”‚  ê¸°ëŒ€: 404 Not Found (RLSê°€ ì°¨ë‹¨)                               â”‚
â”‚  ê²°ê³¼: âœ… í†µê³¼                                                   â”‚
â”‚                                                                  â”‚
â”‚  ì‹œë‚˜ë¦¬ì˜¤ 2: ìš”ì²­ ë°”ë”” company_id ë³€ì¡°                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ê³µê²©: POST /api/v1/vouchers { company_id: "ë‹¤ë¥¸íšŒì‚¬ID" }       â”‚
â”‚  ê¸°ëŒ€: 403 Forbidden ë˜ëŠ” ë¬´ì‹œ (JWTì˜ company_id ì‚¬ìš©)          â”‚
â”‚  ê²°ê³¼: âœ… í†µê³¼                                                   â”‚
â”‚                                                                  â”‚
â”‚  ì‹œë‚˜ë¦¬ì˜¤ 3: SQL Injectionìœ¼ë¡œ RLS ìš°íšŒ ì‹œë„                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ê³µê²©: GET /api/v1/vouchers?status=' OR '1'='1                  â”‚
â”‚  ê¸°ëŒ€: 400 Bad Request (ìž…ë ¥ ê²€ì¦) ë˜ëŠ” ë¹ˆ ê²°ê³¼                 â”‚
â”‚  ê²°ê³¼: âœ… í†µê³¼                                                   â”‚
â”‚                                                                  â”‚
â”‚  ì‹œë‚˜ë¦¬ì˜¤ 4: ì„¸ì…˜ í•˜ì´ìž¬í‚¹ í›„ ë‹¤ë¥¸ í…Œë„ŒíŠ¸ ì ‘ê·¼                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ê³µê²©: í›”ì¹œ í† í°ìœ¼ë¡œ ë‹¤ë¥¸ íšŒì‚¬ ë°ì´í„° ì ‘ê·¼                      â”‚
â”‚  ê¸°ëŒ€: í† í°ì˜ company_idë§Œ ì ‘ê·¼ ê°€ëŠ¥                            â”‚
â”‚  ê²°ê³¼: âœ… í†µê³¼ (í† í°ì— company_id ë°”ì¸ë”©)                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ì„±ëŠ¥ ìµœì í™”

### 5.1 ì¸ë±ìŠ¤ ì „ëžµ

```sql
-- company_id ë³µí•© ì¸ë±ìŠ¤ (RLS ì¿¼ë¦¬ ìµœì í™”)
CREATE INDEX CONCURRENTLY idx_vouchers_company_date
ON vouchers(company_id, voucher_date DESC);

CREATE INDEX CONCURRENTLY idx_voucher_lines_company_voucher
ON voucher_lines(company_id, voucher_id);

CREATE INDEX CONCURRENTLY idx_employees_company_status
ON employees(company_id, status) WHERE status = 'ACTIVE';

-- íŒŒí‹°ì…”ë‹ (ëŒ€ìš©ëŸ‰ í…Œì´ë¸”)
-- ì›”ë³„ íŒŒí‹°ì…˜ + company_id ì¡°ê±´
CREATE TABLE audit_logs (
    id UUID,
    company_id UUID NOT NULL,
    created_at TIMESTAMPTZ NOT NULL,
    ...
) PARTITION BY RANGE (created_at);

CREATE TABLE audit_logs_2025_01 PARTITION OF audit_logs
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

### 5.2 ì»¤ë„¥ì…˜ í’€ ìµœì í™”

```go
// internal/infrastructure/database/postgres.go

func NewPostgresDB(config *Config) (*gorm.DB, error) {
    dsn := config.DatabaseURL

    db, err := gorm.Open(postgres.Open(dsn), &gorm.Config{
        Logger: logger.Default.LogMode(logger.Silent),
        // ì¿¼ë¦¬ ë¡œê¹…ì€ ë³„ë„ ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì²˜ë¦¬
    })
    if err != nil {
        return nil, err
    }

    sqlDB, _ := db.DB()

    // ì»¤ë„¥ì…˜ í’€ ì„¤ì •
    sqlDB.SetMaxOpenConns(config.MaxConnections)    // 25
    sqlDB.SetMaxIdleConns(config.MaxIdleConns)      // 5
    sqlDB.SetConnMaxLifetime(time.Hour)
    sqlDB.SetConnMaxIdleTime(10 * time.Minute)

    // í…Œë„ŒíŠ¸ í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
    db.Use(&TenantPlugin{})

    return db, nil
}
```

---

## 6. ìš´ì˜ ê³ ë ¤ì‚¬í•­

### 6.1 í…Œë„ŒíŠ¸ ì˜¨ë³´ë”©

```go
// internal/service/tenant/onboarding_service.go

func (s *OnboardingService) CreateTenant(ctx context.Context, input *CreateTenantInput) (*domain.Company, error) {
    // íŠ¸ëžœìž­ì…˜ìœ¼ë¡œ ì›ìžì  ì²˜ë¦¬
    return s.db.Transaction(func(tx *gorm.DB) error {
        // 1. íšŒì‚¬ ìƒì„±
        company := &domain.Company{
            BusinessNumber: input.BusinessNumber,
            Name:          input.CompanyName,
            CEOName:       input.CEOName,
        }
        if err := tx.Create(company).Error; err != nil {
            return err
        }

        // 2. ê´€ë¦¬ìž ì‚¬ìš©ìž ìƒì„±
        adminUser := &domain.User{
            CompanyID: company.ID,
            Email:     input.AdminEmail,
            Name:      input.AdminName,
            // ... ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ
        }
        if err := tx.Create(adminUser).Error; err != nil {
            return err
        }

        // 3. ê¸°ë³¸ ê³„ì •ê³¼ëª© ë³µì‚¬ (í…œí”Œë¦¿ì—ì„œ)
        if err := s.copyDefaultAccounts(tx, company.ID); err != nil {
            return err
        }

        // 4. ê¸°ë³¸ ì—­í• /ê¶Œí•œ ì„¤ì •
        if err := s.setupDefaultRoles(tx, company.ID, adminUser.ID); err != nil {
            return err
        }

        return nil
    })
}
```

### 6.2 í…Œë„ŒíŠ¸ ë°ì´í„° ì‚­ì œ (GDPR ëŒ€ì‘)

```go
// internal/service/tenant/deletion_service.go

func (s *DeletionService) DeleteTenant(ctx context.Context, companyID uuid.UUID) error {
    // ì†Œí”„íŠ¸ ì‚­ì œ + 30ì¼ í›„ ì™„ì „ ì‚­ì œ
    return s.db.Transaction(func(tx *gorm.DB) error {
        // 1. íšŒì‚¬ ë¹„í™œì„±í™”
        if err := tx.Model(&domain.Company{}).
            Where("id = ?", companyID).
            Update("is_active", false).
            Update("deleted_at", time.Now()).Error; err != nil {
            return err
        }

        // 2. ì‚­ì œ ì˜ˆì•½ íì— ì¶”ê°€
        return s.queue.Publish("tenant.deletion.scheduled", &TenantDeletionEvent{
            CompanyID:   companyID,
            ScheduledAt: time.Now().Add(30 * 24 * time.Hour),
        })
    })
}

// 30ì¼ í›„ ì‹¤í–‰ë˜ëŠ” ì›Œì»¤
func (w *DeletionWorker) PermanentDelete(companyID uuid.UUID) error {
    // CASCADE ì‚­ì œ ë˜ëŠ” í…Œì´ë¸”ë³„ ìˆœì°¨ ì‚­ì œ
    tables := []string{
        "audit_logs", "tax_invoices", "voucher_lines", "vouchers",
        "employees", "accounts", "users", "companies",
    }

    for _, table := range tables {
        if _, err := w.db.Exec(
            fmt.Sprintf("DELETE FROM %s WHERE company_id = $1", table),
            companyID,
        ); err != nil {
            return err
        }
    }

    return nil
}
```

---

**ë¬¸ì„œ ë²„ì „**: 1.0
**ìž‘ì„±ì¼**: 2025ë…„ 1ì›”
**ë‹¤ìŒ ê²€í† ì¼**: 2025ë…„ 4ì›”
